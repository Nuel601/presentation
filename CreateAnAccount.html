<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Account - Barangay 118 Online System</title>
    <meta name="description" content="Register for your Barangay 118 account to access online services and government transactions">
    <meta name="keywords" content="barangay, registration, online system, government services">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="Logo-Favicon-removebg-preview.png">
    <link rel="shortcut icon" href="Logo-Favicon-removebg-preview.png" type="image/png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="CreateAnAccount.css">
</head>
<body>
    <!-- Dynamic Header Placeholder - Controlled by PanelAdmin.html -->
    <div id="dynamic-header-placeholder"></div>

    <!-- Page Hero -->
    <section class="page-hero">
        <div class="container">
            <h1 id="hero-title">Create an Account</h1>
            <p id="hero-description">Register in minutes to access secure and convenient barangay services online.</p> 
        </div>
    </section>

    <!-- Main Content with Sidebar -->
    <div class="container">
        <div class="main-content" id="main-content">
            <!-- Registration Form -->
            <div class="form-container">
                <!-- Form Header with Progress -->
                <div class="form-header">
                    <h2 class="form-title">CREATE YOUR BARANGAY ACCOUNT</h2>
                    <div class="step-counter" aria-live="polite" aria-atomic="true">
                        Step <span id="current-step-number">1</span> of 5
                        <span class="step-description" id="step-description">- Head of Family Information</span>
                    </div>
                </div>

                <!-- Enhanced Progress Steps -->
                <div class="progress-steps" role="progressbar" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100" aria-label="Registration progress">
                    <div class="progress-bar" id="progress-bar" style="width: 20%;"></div>
                    
                    <div class="step active" id="step1-indicator" role="button" tabindex="0" onclick="showStepDirect(1)">
                        <div class="step-number" aria-hidden="true">1</div>
                        <div class="step-label">Personal Info</div>
                        <div class="step-status" aria-live="polite">Current</div>
                    </div>
                    
                    <div class="step" id="step2-indicator" role="button" tabindex="0" onclick="showStepDirect(2)">
                        <div class="step-number" aria-hidden="true">2</div>
                        <div class="step-label">Household</div>
                        <div class="step-status" aria-live="polite">Pending</div>
                    </div>
                    
                    <div class="step" id="step3-indicator" role="button" tabindex="0" onclick="showStepDirect(3)">
                        <div class="step-number" aria-hidden="true">3</div>
                        <div class="step-label">Documents</div>
                        <div class="step-status" aria-live="polite">Pending</div>
                    </div>
                    
                    <div class="step" id="step4-indicator" role="button" tabindex="0" onclick="showStepDirect(4)">
                        <div class="step-number" aria-hidden="true">4</div>
                        <div class="step-label">Face Scan</div>
                        <div class="step-status" aria-live="polite">Pending</div>
                    </div>
                    
                    <div class="step" id="step5-indicator" role="button" tabindex="0" onclick="showStepDirect(5)">
                        <div class="step-number" aria-hidden="true">5</div>
                        <div class="step-label">Complete</div>
                        <div class="step-status" aria-live="polite">Pending</div>
                    </div>
                </div>
                
                <!-- Step 1: Head of the Family Information -->
                <div class="form-section active" id="step1" role="tabpanel" aria-labelledby="step1-indicator">
                    <div class="section-header">
                        <h3 class="section-title">Personal Information</h3>
                        <p class="section-description">Please provide your basic personal details. All fields marked with <span class="required-marker">*</span> are required.</p>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="lastName" class="required">Last Name <span class="required-marker">*</span></label>
                            <input type="text" id="lastName" placeholder="Enter your last name" required aria-required="true">
                            <small class="note">Example: Dela Cruz</small>
                            <div class="error-message" id="lastName-error" role="alert" aria-live="polite">Please enter your last name</div>
                        </div>

                        <div class="form-group">
                            <label for="firstName" class="required">First Name <span class="required-marker">*</span></label>
                            <input type="text" id="firstName" placeholder="Enter your first name" required aria-required="true">
                            <small class="note">Example: Juan</small>
                            <div class="error-message" id="firstName-error" role="alert" aria-live="polite">Please enter your first name</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="middleName">Middle Name</label>
                            <input type="text" id="middleName" placeholder="Type 'N/A' if not applicable" aria-describedby="middleName-help">
                            <small class="note" id="middleName-help">Example: Santos or N/A</small>
                            <div class="error-message" id="middleName-error" role="alert" aria-live="polite" style="display:none;">
                                Please enter your middle name (or type N/A)
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="extName">Extension Name</label>
                            <select id="extName" onchange="toggleOtherExt(this)" aria-describedby="extName-help">
                                <option value="" disabled selected>Select Extension Name</option>
                                <option value="Jr.">Jr.</option>
                                <option value="Sr.">Sr.</option>
                                <option value="II">II</option>
                                <option value="III">III</option>
                                <option value="IV">IV</option>
                                <option value="N/A">N/A</option>
                                <option value="Other">Other</option>
                            </select>
                            <input type="text" id="otherExt" placeholder="Please specify your extension name" style="display:none; margin-top:8px;" aria-label="Other extension name">
                            <div class="error-message" id="extName-error" role="alert" aria-live="polite" style="display:none;">
                                Please select an extension name
                            </div>
                            <div class="error-message" id="otherExt-error" role="alert" aria-live="polite" style="display:none;">
                                Please specify your extension name when 'Other' is selected
                            </div>
                            <small class="note" id="extName-help">Example: Jr., Sr., N/A, or enter other</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="gender" class="required">Gender <span class="required-marker">*</span></label>
                            <select id="gender" required aria-required="true">
                                <option value="" disabled selected>Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                            <small class="note">Example: Male or Female</small>
                            <div class="error-message" id="gender-error" role="alert" aria-live="polite">Please select your gender</div>
                        </div>

                        <div class="form-group">
                            <label for="dateOfBirth" class="required">Date of Birth <span class="required-marker">*</span></label>
                            <input type="date" id="dateOfBirth" required aria-required="true" aria-describedby="dob-help">
                            <small class="note" id="dob-help">You must be at least 18 years old to register</small>
                            <div class="error-message" id="dateOfBirth-error" role="alert" aria-live="polite">Please enter your date of birth</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="address" class="required">Complete Address <span class="required-marker">*</span></label>
                        <input type="text" id="address" placeholder="Enter your complete address including house number, street, and barangay" required aria-required="true">
                        <small class="note">Example: 123 Mabini St., Brgy. San Roque, Caloocan City, Metro Manila</small>
                        <div class="error-message" id="address-error" role="alert" aria-live="polite">Please enter your complete address</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="placeOfBirth" class="required">Place of Birth <span class="required-marker">*</span></label>
                            <input type="text" id="placeOfBirth" placeholder="Enter city and province where you were born" required aria-required="true">
                            <small class="note">Example: Caloocan City, Metro Manila, Philippines</small>
                            <div class="error-message" id="placeOfBirth-error" role="alert" aria-live="polite">Please enter your place of birth</div>
                        </div>
                        <div class="form-group">
                            <label for="age" class="required">Age <span class="required-marker">*</span></label>
                            <input type="number" id="age" placeholder="Enter your age" min="18" max="120" aria-describedby="age-help" readonly>
                            <small class="note" id="age-help">Automatically calculated from your birth date</small>
                            <div class="error-message" id="age-error" role="alert" aria-live="polite">Please enter your age</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="phone" class="required">Phone Number <span class="required-marker">*</span></label>
                            <div class="phone-wrapper">
                                <span class="prefix">+63</span>
                                <input type="tel" id="phone" placeholder="912-345-6789" required aria-required="true" pattern="^9\d{2}[- ]?\d{3}[- ]?\d{4}$">
                            </div>
                            <small class="note">Format: 912-345-6789</small>
                            <div class="error-message" id="phone-error" role="alert" aria-live="polite">Please enter a valid Philippine phone number</div>
                        </div>
                        <div class="form-group">
                            <label for="civilStatus" class="required">Civil Status <span class="required-marker">*</span></label>
                            <select id="civilStatus" required aria-required="true">
                                <option value="" disabled selected>Select Civil Status</option>
                                <option value="single">Single</option>
                                <option value="married">Married</option>
                                <option value="widowed">Widowed</option>
                                <option value="separated">Separated</option>
                                <option value="divorced">Divorced</option>
                            </select>
                            <small class="note">Example: Single</small>
                            <div class="error-message" id="civilStatus-error" role="alert" aria-live="polite">Please select your civil status</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="citizenship" class="required">Citizenship <span class="required-marker">*</span></label>
                            <select id="citizenship" required aria-required="true" onchange="toggleOtherInput(this, 'otherCitizenship')">
                                <option value="" disabled selected>Select Citizenship</option>
                                <option value="Filipino">Filipino</option>
                                <option value="Dual Citizen">Dual Citizen</option>
                                <option value="Other">Other</option>
                            </select>
                            <input type="text" id="otherCitizenship" placeholder="Please specify your citizenship" style="display:none; margin-top:8px;" aria-label="Other citizenship">
                            <small class="note">Example: Filipino</small>
                            <div class="error-message" id="citizenship-error" role="alert" aria-live="polite">Please select your citizenship</div>
                        </div>
                        <div class="form-group">
                            <label for="occupation" class="required">Occupation <span class="required-marker">*</span></label>
                            <select id="occupation" required aria-required="true" onchange="toggleOtherInput(this, 'otherOccupation')">
                                <option value="" disabled selected>Select Occupation</option>
                                <option value="Student">Student</option>
                                <option value="Teacher">Teacher</option>
                                <option value="Engineer">Engineer</option>
                                <option value="Nurse">Nurse</option>
                                <option value="Doctor">Doctor</option>
                                <option value="Business Owner">Business Owner</option>
                                <option value="Government Employee">Government Employee</option>
                                <option value="Private Employee">Private Employee</option>
                                <option value="Unemployed">Unemployed</option>
                                <option value="Other">Other</option>
                            </select>
                            <input type="text" id="otherOccupation" placeholder="Please specify your occupation" style="display:none; margin-top:8px;" aria-label="Other occupation">
                            <small class="note">Example: Student, Teacher, or specify if other</small>
                            <div class="error-message" id="occupation-error" role="alert" aria-live="polite">Please select your occupation</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Special Categories (Check all that apply) <span class="required-marker">*</span></label>
                        <div class="checkbox-group four-columns" role="group" aria-labelledby="special-categories-label">
                            <div class="checkbox-item">
                                <input type="checkbox" id="labor" name="indicateIf[]" value="Labor">
                                <label for="labor">Labor</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="pwd" name="indicateIf[]" value="PWD">
                                <label for="pwd">PWD</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="unemployed" name="indicateIf[]" value="Unemployed">
                                <label for="unemployed">Unemployed</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="ofw" name="indicateIf[]" value="OFW">
                                <label for="ofw">OFW</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="soloParent" name="indicateIf[]" value="Solo Parent">
                                <label for="soloParent">Solo Parent</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="student" name="indicateIf[]" value="Student">
                                <label for="student">Student</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="osy" name="indicateIf[]" value="OSY">
                                <label for="osy">OSY</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="osc" name="indicateIf[]" value="OSC">
                                <label for="osc">OSC</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="senior" name="indicateIf[]" value="Senior Citizen">
                                <label for="senior">Senior Citizen</label>
                            </div>
                        </div>
                        <small class="note">These categories help us provide appropriate services and assistance</small>
                    </div>
                
                    <div class="section-header">
                        <h3 class="section-title">Account Security</h3>
                        <p class="section-description">Set up your login credentials and verify your email address.</p>
                    </div>
                    
                    <div class="form-group email-otp-group">
                        <label for="email" class="required">Email Address <span class="required-marker">*</span></label>
                        <div class="otp-container">
                            <input type="email" id="email" placeholder="Enter your active email address" required aria-required="true" aria-describedby="email-help">
                            <button type="button" class="otp-btn" id="send-otp" aria-label="Send verification code to email">
                                <i class="fas fa-paper-plane" aria-hidden="true"></i> Send OTP
                            </button>
                        </div>
                        <small class="note" id="email-help">We'll send a 6-digit verification code to your email</small>
                        <div class="error-message" id="email-error" role="alert" aria-live="polite">Please enter a valid email address</div>
                        <div class="success-message" id="email-success" style="display:none;" role="alert" aria-live="polite">
                            <i class="fas fa-check-circle" aria-hidden="true"></i> Valid email format.
                        </div>
                        <div class="otp-countdown" id="otp-countdown" style="display:none;" aria-live="polite">
                            <i class="fas fa-clock" aria-hidden="true"></i> Resend available in: <span id="countdown-timer">60</span>s
                        </div>
                    </div>
                    
                    <div class="form-group otp-verification-group" id="otp-input-group" style="display:none;">
                        <label for="otpInput" class="required">OTP Verification <span class="required-marker">*</span></label>
                        <div class="otp-container">
                            <input type="text" id="otpInput" placeholder="Enter 6-digit OTP" maxlength="6" pattern="[0-9]{6}" aria-describedby="otp-help">
                            <button type="button" class="otp-btn" id="verify-otp-btn" aria-label="Verify OTP code">
                                <i class="fas fa-check-circle" aria-hidden="true"></i> Verify OTP
                            </button>
                        </div>
                        <small class="note" id="otp-help">Enter the 6-digit code sent to your email</small>
                        <div class="error-message" id="otp-error" role="alert" aria-live="polite">Incorrect OTP. Please try again.</div>
                        <div class="success-message" id="otp-success" style="display:none;" role="alert" aria-live="polite">
                            <i class="fas fa-check-circle" aria-hidden="true"></i> Email verified successfully!
                        </div>
                        <div class="otp-resend" id="otp-resend" style="display:none;">
                            <button type="button" class="otp-btn" id="resend-otp" aria-label="Resend OTP code">
                                <i class="fas fa-redo" aria-hidden="true"></i> Resend OTP
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="password" class="required">Password <span class="required-marker">*</span></label>
                            <div class="password-input-container">
                                <input type="password" id="password" placeholder="Create a strong password" required aria-required="true" aria-describedby="password-requirements">
                                <button type="button" class="password-toggle" id="togglePassword" aria-label="Show password">
                                    <i class="fas fa-eye" aria-hidden="true"></i> Show
                                </button>
                            </div>
                            <small class="note">Example: MyStrongP@ssword1</small>
                            <div class="error-message" id="password-error" role="alert" aria-live="polite">
                                Please enter a valid password that meets all requirements
                            </div>
                            <div class="password-requirements" id="password-requirements" role="region" aria-live="polite">
                                <p class="requirements-title">Password must contain:</p>
                                <ul>
                                    <li id="req-length" class="invalid">At least <strong>10 characters</strong></li>
                                    <li id="req-uppercase" class="invalid">At least <strong>1 uppercase letter</strong></li>
                                    <li id="req-lowercase" class="invalid">At least <strong>1 lowercase letter</strong></li>
                                    <li id="req-number" class="invalid">At least <strong>1 number</strong></li>
                                    <li id="req-special" class="invalid">At least <strong>1 special character</strong> (e.g., @, _, >, <, ,, ?)</li>
                                </ul>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword" class="required">Confirm Password <span class="required-marker">*</span></label>
                            <div class="password-input-container">
                                <input type="password" id="confirmPassword" placeholder="Re-enter your password" required aria-required="true">
                                <button type="button" class="password-toggle" id="toggleConfirmPassword" aria-label="Show password confirmation">
                                    <i class="fas fa-eye" aria-hidden="true"></i> Show
                                </button>
                            </div>
                            <small class="note">Re-type the password above</small>
                            <div class="error-message" id="confirmPassword-error" role="alert" aria-live="polite">
                                Passwords do not match
                            </div>
                            <div class="password-match" id="password-match-message" role="alert" aria-live="polite">
                                <i class="fas fa-check-circle" aria-hidden="true"></i> Passwords match!
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-prev" disabled aria-label="Previous step">
                            <i class="fas fa-arrow-left" aria-hidden="true"></i> Previous
                        </button>
                        <button type="button" class="btn btn-next" id="show-terms-btn" aria-label="Continue to terms and conditions">
                            Continue to Terms <i class="fas fa-arrow-right" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Step 2: Household Information -->
                <div class="form-section" id="step2" role="tabpanel" aria-labelledby="step2-indicator">
                    <div class="section-header">
                        <h3 class="section-title">Household Information</h3>
                        <p class="section-description">Provide details about your household and residence. If some information is not applicable, you may enter <strong>N/A</strong>.</p>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="householdMembers" class="required">Number of Household Members <span class="required-marker">*</span></label>
                            <input type="number" id="householdMembers" placeholder="Enter number of members" min="1" max="20" aria-describedby="householdMembers-help" required>
                            <small class="note" id="householdMembers-help">Example: 5 members including yourself</small>
                            <div class="error-message" id="householdMembers-error" role="alert" aria-live="polite">Please enter number of household members</div>
                        </div>
                        <div class="form-group">
                            <label for="ownerName">Property Owner's Name</label>
                            <input type="text" id="ownerName" placeholder="Enter property owner's full name or N/A if not applicable">
                            <small class="note">Example: Juan Dela Cruz (or N/A if you are not the owner)</small>
                            <div class="error-message" id="ownerName-error" role="alert" aria-live="polite">Please enter owner's name or N/A</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="precinctNo">Precinct Number</label>
                            <input type="text" id="precinctNo" placeholder="Enter precinct number or N/A" aria-describedby="precinct-help">
                            <small class="note" id="precinct-help">Example: 123A (or N/A if not applicable)</small>
                        </div>
                        <div class="form-group">
                            <label for="yearsInBarangay" class="required">Years Residing in Barangay <span class="required-marker">*</span></label>
                            <input type="number" id="yearsInBarangay" placeholder="Enter number of years" min="0" max="100" aria-describedby="years-help" required>
                            <small class="note" id="years-help">Example: 10 years (0 if less than 1 year)</small>
                            <div class="error-message" id="yearsInBarangay-error" role="alert" aria-live="polite">Please enter number of years</div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-prev" aria-label="Go back to personal information">
                            <i class="fas fa-arrow-left" aria-hidden="true"></i> Previous
                        </button>
                        <button type="button" class="btn btn-next" aria-label="Continue to document upload">
                            Continue to Documents <i class="fas fa-arrow-right" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Upload your Valid ID's -->
                <div class="form-section" id="step3" role="tabpanel" aria-labelledby="step3-indicator">
                    <div class="section-header">
                        <h3 class="section-title">Identity Verification</h3>
                        <p class="section-description">Upload a valid government-issued ID for identity verification.</p>
                    </div>
                    
                    <!-- ID Type -->
                    <div class="form-group">
                        <label for="idType" class="required">Select ID Type <span class="required-marker">*</span></label>
                        <select id="idType" required aria-required="true" aria-describedby="idType-help" onchange="toggleIDUpload(this)">
                            <option value="">Select ID Type</option>
                            <option value="passport">Passport</option>
                            <option value="driver">Driver's License</option>
                            <option value="national">National ID (PhilID)</option>
                            <option value="voter">Voter's ID</option>
                            <option value="postal">Postal ID</option>
                            <option value="student">Student ID</option>
                            <option value="other">Other Government ID</option>
                            <option value="none">None / No ID</option>
                        </select>
                        <small class="note" id="idType-help">Choose the primary government-issued ID you will upload. Select "None/No ID" if you don't have any.</small>
                        <div class="error-message" id="idType-error" role="alert" aria-live="polite">Please select an ID type</div>
                    </div>
                    
                    <!-- Upload Front of ID -->
                    <div class="form-group id-upload-section" id="id-front-section">
                        <label for="idFront" class="required">Upload Front of ID <span class="required-marker">*</span></label>
                        <div class="file-upload-container">
                            <label for="idFront" class="file-upload-label">
                                <i class="fas fa-upload" aria-hidden="true"></i> Click to upload the front of your valid ID
                            </label>
                            <input type="file" id="idFront" class="file-upload-input" accept=".jpg,.jpeg,.png,.pdf" aria-describedby="idFront-help">
                        </div>
                        <small class="note" id="idFront-help">Ensure the front side is clear and readable (Max: 5MB)</small>
                        <div class="error-message" id="idFront-error" role="alert" aria-live="polite">Please upload the front of your ID</div>
                        <div class="file-preview-container" id="idFrontPreviewContainer" style="display: none;">
                            <img id="idFrontImagePreview" class="image-preview" alt="Uploaded front ID preview">
                            <button type="button" class="delete-file-btn" id="deleteIdFront" aria-label="Remove front ID file">×</button>
                        </div>
                    </div>

                    <!-- Upload Back of ID -->
                    <div class="form-group id-upload-section" id="id-back-section">
                        <label for="idBack" class="required">Upload Back of ID <span class="required-marker">*</span></label>
                        <div class="file-upload-container">
                            <label for="idBack" class="file-upload-label">
                                <i class="fas fa-upload" aria-hidden="true"></i> Click to upload the back of your valid ID
                            </label>
                            <input type="file" id="idBack" class="file-upload-input" accept=".jpg,.jpeg,.png,.pdf" aria-describedby="idBack-help">
                        </div>
                        <small class="note" id="idBack-help">Ensure the back side is clear and readable (Max: 5MB)</small>
                        <div class="error-message" id="idBack-error" role="alert" aria-live="polite">Please upload the back of your ID</div>
                        <div class="file-preview-container" id="idBackPreviewContainer" style="display: none;">
                            <img id="idBackImagePreview" class="image-preview" alt="Uploaded back ID preview">
                            <button type="button" class="delete-file-btn" id="deleteIdBack" aria-label="Remove back ID file">×</button>
                        </div>
                    </div>

                    <!-- Alternative for No ID -->
                    <div class="form-group no-id-section" id="no-id-section" style="display: none;">
                        <div class="info-box">
                            <i class="fas fa-info-circle"></i>
                            <p>If you don't have a government-issued ID, you may proceed and barangay officials will verify your identity through other means. Please provide additional information in the reason field below.</p>
                        </div>
                    </div>

                    <!-- User Reason -->
                    <div class="form-group">
                        <label for="userReason" class="required">Reason for creating an account <span class="required-marker">*</span></label>
                        <textarea id="userReason" placeholder="Explain why you are creating this account (e.g., residency registration, document request, etc.)" required aria-required="true" rows="3"></textarea>
                        <div class="error-message" id="userReason-error" role="alert" aria-live="polite">
                            Please provide a reason
                        </div>
                    </div>

                    <!-- Verification Tips -->
                    <div class="verification-tips">
                        <h4><i class="fas fa-lightbulb" aria-hidden="true"></i> ID Upload Tips</h4>
                        <ul class="tips-grid">
                            <li><i class="fas fa-check"></i> Ensure the ID is not expired</li>
                            <li><i class="fas fa-check"></i> Photo and details should be clear and readable</li>
                            <li><i class="fas fa-check"></i> File should be well-lit without glare</li>
                            <li><i class="fas fa-check"></i> Upload the front side of the ID</li>
                            <li><i class="fas fa-check"></i> Upload the back side of the ID</li>
                            <li><i class="fas fa-check"></i> File should not be blurry or edited</li>
                            <li><i class="fas fa-check"></i> Make sure all corners of the ID are visible</li>
                            <li><i class="fas fa-check"></i> Do not cover any part of the ID</li>
                            <li><i class="fas fa-check"></i> Upload only one file per ID</li>
                            <li><i class="fas fa-check"></i> Ensure file size does not exceed 5 MB</li>
                        </ul>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-prev" aria-label="Go back to household information">
                            <i class="fas fa-arrow-left" aria-hidden="true"></i> Previous
                        </button>
                        <button type="button" class="btn btn-next" aria-label="Continue to face verification">
                            Continue to Face Verification <i class="fas fa-arrow-right" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 4: Face Scan -->
                <div class="form-section" id="step4" role="tabpanel" aria-labelledby="step4-indicator">
                    <div class="section-header">
                        <h3 class="section-title">Face Verification</h3>
                        <p class="section-description">We need to capture your face from different angles to verify your identity against your ID.</p>
                    </div>
                    
                    <div class="face-scan-container">
                        <div class="face-scan-progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Face capture progress">
                            <div class="progress-circle active" id="progress-front">
                                <span class="sr-only">Front face - pending</span>
                                <span class="progress-number">1</span>
                            </div>
                            <div class="progress-connector" id="connector-1" aria-hidden="true"></div>
                            <div class="progress-circle" id="progress-left">
                                <span class="sr-only">Left side - pending</span>
                                <span class="progress-number">2</span>
                            </div>
                            <div class="progress-connector" id="connector-2" aria-hidden="true"></div>
                            <div class="progress-circle" id="progress-right">
                                <span class="sr-only">Right side - pending</span>
                                <span class="progress-number">3</span>
                            </div>
                            <div class="progress-connector" id="connector-3" aria-hidden="true"></div>
                            <div class="progress-circle" id="progress-closed">
                                <span class="sr-only">Closed eyes - pending</span>
                                <span class="progress-number">4</span>
                            </div>
                        </div>                        
                        
                        <div class="face-scan-instructions" id="face-instructions" role="status" aria-live="polite">
                            Please look directly at the camera for the front face capture
                        </div>
                        
                        <div class="webcam-container">
                            <div class="face-capture-circle" role="img" aria-label="Face capture area">
                                <video id="webcamVideo" class="webcam-video" autoplay playsinline aria-label="Live camera feed"></video>
                                <canvas id="webcamCanvas" class="webcam-canvas" aria-hidden="true"></canvas>
                                <img id="capturedImage" class="captured-image" alt="Captured face image">
                                <div class="face-guide"></div>
                            </div>
                            
                            <div class="face-scan-status" id="face-status" role="status" aria-live="polite">
                                <i class="fas fa-sync-alt" aria-hidden="true"></i> Camera ready - Please start camera to begin
                            </div>
                            
                            <div class="capture-controls">
                                <button type="button" class="capture-btn" id="startWebcam" aria-label="Start camera for face capture">
                                    <i class="fas fa-camera" aria-hidden="true"></i> Start Camera
                                </button>
                                <button type="button" class="capture-btn" id="captureImage" disabled aria-label="Capture current face image">
                                    <i class="fas fa-circle" aria-hidden="true"></i> Capture Photo
                                </button>
                                <button type="button" class="capture-btn" id="retakeImage" style="display:none;" aria-label="Retake face capture">
                                    <i class="fas fa-redo" aria-hidden="true"></i> Retake
                                </button>
                            </div>
                            
                            <!-- Fallback for no webcam -->
                            <div class="webcam-fallback" id="webcam-fallback" style="display: none;">
                                <p><i class="fas fa-exclamation-triangle"></i> Camera not accessible. Please:</p>
                                <ol>
                                    <li>Check camera permissions</li>
                                    <li>Try another device</li>
                                    <li>Or <button type="button" class="btn-link" id="upload-photo-btn">upload a photo instead</button></li>
                                </ol>
                            </div>
                        </div>
                        
                        <div class="face-capture-steps">
                            <!-- Front Face -->
                            <div class="capture-step active" id="step-front">
                                <div class="step-header">
                                    <div class="step-indicator">1</div>
                                    <div class="step-title">Front Face</div>
                                    <button type="button" class="retake-face-btn" data-face="front" aria-label="Retake front face photo">↺</button>
                                </div>
                                <div class="face-capture-preview-container">
                                    <img id="frontFacePreview" class="face-capture-preview" alt="Front face capture preview">
                                </div>
                                <button class="step-capture-btn" id="capture-front" disabled aria-label="Capture front face">Capture Front</button>
                            </div>
                        
                            <!-- Left Side -->
                            <div class="capture-step" id="step-left">
                                <div class="step-header">
                                    <div class="step-indicator">2</div>
                                    <div class="step-title">Left Side</div>
                                    <button type="button" class="retake-face-btn" data-face="left" aria-label="Retake left side photo">↺</button>
                                </div>
                                <div class="face-capture-preview-container">
                                    <img id="leftFacePreview" class="face-capture-preview" alt="Left side face capture preview">
                                </div>
                                <button class="step-capture-btn" id="capture-left" disabled aria-label="Capture left side face">Capture Left</button>
                            </div>
                        
                            <!-- Right Side -->
                            <div class="capture-step" id="step-right">
                                <div class="step-header">
                                    <div class="step-indicator">3</div>
                                    <div class="step-title">Right Side</div>
                                    <button type="button" class="retake-face-btn" data-face="right" aria-label="Retake right side photo">↺</button>
                                </div>
                                <div class="face-capture-preview-container">
                                    <img id="rightFacePreview" class="face-capture-preview" alt="Right side face capture preview">
                                </div>
                                <button class="step-capture-btn" id="capture-right" disabled aria-label="Capture right side face">Capture Right</button>
                            </div>
                        
                            <!-- Closed Eyes -->
                            <div class="capture-step" id="step-closed">
                                <div class="step-header">
                                    <div class="step-indicator">4</div>
                                    <div class="step-title">Closed Eyes</div>
                                    <button type="button" class="retake-face-btn" data-face="closed" aria-label="Retake closed eyes photo">↺</button>
                                </div>
                                <div class="face-capture-preview-container">
                                    <img id="closedFacePreview" class="face-capture-preview" alt="Closed eyes face capture preview">
                                </div>
                                <button class="step-capture-btn" id="capture-closed" disabled aria-label="Capture closed eyes">Capture Closed</button>
                            </div>
                        </div>                        
                    </div>
                    
                    <div class="face-scan-tips">
                        <h4><i class="fas fa-lightbulb" aria-hidden="true"></i> Face Scan Tips:</h4>
                        <ul>
                            <li>Make sure there is enough light around you, but avoid direct light on your face</li>
                            <li>Remove accessories like glasses, hats, or large earrings</li>
                            <li>Keep your face within the circular frame</li>
                            <li>Follow the instructions for each capture angle</li>
                            <li>For the closed eyes photo, gently close your eyes - don't squeeze them shut</li>
                            <li>Ensure your face matches your ID photo</li>
                        </ul>
                    </div>
                    
                    <div class="privacy-notice">
                        <h4><i class="fas fa-shield-alt" aria-hidden="true"></i> Privacy Assurance</h4>
                        <p>Your facial data is securely encrypted and used only for identity verification purposes. We do not store biometric data after verification is complete.</p>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-prev" aria-label="Go back to document upload">
                            <i class="fas fa-arrow-left" aria-hidden="true"></i> Previous
                        </button>
                        <button type="button" class="btn btn-next" id="completeFaceScan" disabled aria-label="Complete face verification and proceed to review">
                            Complete Verification <i class="fas fa-arrow-right" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Step 5: Success Page -->
                <div class="form-section" id="step5" role="tabpanel" aria-labelledby="step5-indicator">
                    <div class="success-container">
                        <div class="success-checkmark" aria-hidden="true">
                            <i class="fas fa-check"></i>
                        </div>
                        <h2 class="form-title">Account Registration Submitted Successfully!</h2>

                        <div class="control-number-container">
                            <p class="control-label">Your Registration Control Number:</p>
                            <div class="control-number-display">
                                <span class="control-number" id="controlNumber" aria-label="Your registration control number">BRGY118-20251218-001</span>
                                <button type="button" class="btn-copy" id="copy-control-number" aria-label="Copy control number">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <small class="note">Please save this number for future reference. You can also take a screenshot.</small>
                        </div>

                        <p class="submission-message">
                            Your account registration has been successfully submitted for review.
                            Please allow <strong>1 to 4 business days</strong> for our admin to verify your information and process your account.
                            <br><br>
                            <strong>Estimated processing date:</strong> <span id="estimated-date"></span>
                        </p>

                        <div class="next-steps">
                            <h4><i class="fas fa-list-alt" aria-hidden="true"></i> What Happens Next</h4>
                            <div class="timeline" role="list">
                                <div class="timeline-item" role="listitem">
                                    <div class="timeline-marker" aria-hidden="true"></div>
                                    <div class="timeline-content">
                                        <strong>Document Verification</strong>
                                        <p>Our administrator will carefully review your submitted information and documents.</p>
                                    </div>
                                </div>
                                <div class="timeline-item" role="listitem">
                                    <div class="timeline-marker" aria-hidden="true"></div>
                                    <div class="timeline-content">
                                        <strong>Email Notification</strong>
                                        <p>You will receive an email notification once your account is approved or if additional information is needed.</p>
                                    </div>
                                </div>
                                <div class="timeline-item" role="listitem">
                                    <div class="timeline-marker" aria-hidden="true"></div>
                                    <div class="timeline-content">
                                        <strong>Account Activation</strong>
                                        <p>Once approved, you can log in using your registered email and password to access barangay services.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="contact-support">
                            <h4><i class="fas fa-headset" aria-hidden="true"></i> Need Assistance?</h4>
                            <p>If you have any questions or need to update your application, please contact our support team:</p>
                            <div class="contact-details">
                                <p><i class="fas fa-phone" aria-hidden="true"></i> (02) 8123-4567</p>
                                <p><i class="fas fa-envelope" aria-hidden="true"></i> support@barangay118.gov.ph</p>
                                <p><i class="fas fa-clock" aria-hidden="true"></i> Mon-Fri: 8:00 AM - 5:00 PM</p>
                                <p><i class="fas fa-map-marker-alt" aria-hidden="true"></i> Barangay 118 Office, 402 2nd St, Grace Park East, Caloocan</p>
                            </div>
                        </div>

                        <div class="form-actions success-actions">
                            <button type="button" class="btn btn-prev" aria-label="Go back to face verification">
                                <i class="fas fa-arrow-left" aria-hidden="true"></i> Previous Step
                            </button>
                            <button type="button" class="btn btn-next" id="returnToHome" aria-label="Return to home page">
                                <i class="fas fa-home" aria-hidden="true"></i> Return to Home
                            </button>
                            <button type="button" class="btn btn-secondary" id="printConfirmation" aria-label="Print registration confirmation">
                                <i class="fas fa-print" aria-hidden="true"></i> Print Confirmation
                            </button>
                            <button type="button" class="btn btn-secondary" id="shareEmail" aria-label="Share confirmation via email">
                                <i class="fas fa-share-alt" aria-hidden="true"></i> Share via Email
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar (Only shown on Step 1) -->
            <aside class="info-sidebar" id="info-sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-clipboard-list" aria-hidden="true"></i> Registration Guide</h3>
                    <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                <section class="requirements-section">
                    <h4><i class="fas fa-flag"></i> Required Documents</h4>
                    <div class="requirements-list">
                        <div class="requirement-item">
                            <div class="requirement-icon">
                                <i class="fas fa-id-card"></i>
                            </div>
                            <div class="requirement-text">
                                <strong>Valid Government ID:</strong> Passport, driver's license, national ID, etc.
                            </div>
                        </div>
                        <div class="requirement-item">
                            <div class="requirement-icon">
                                <i class="fas fa-file-contract"></i>
                            </div>
                            <div class="requirement-text">
                                <strong>Proof of Residence:</strong> Utility bills or barangay clearance
                            </div>
                        </div>
                        <div class="requirement-item">
                            <div class="requirement-icon">
                                <i class="fas fa-camera"></i>
                            </div>
                            <div class="requirement-text">
                                <strong>Recent Photos:</strong> For face verification process
                            </div>
                        </div>
                    </div>
                </section>

                <div class="card benefits-card">
                    <h4><i class="fas fa-star" aria-hidden="true"></i> Benefits of Registration</h4>
                    <ul>
                        <li><i class="fas fa-check"></i> Access to online barangay services 24/7</li>
                        <li><i class="fas fa-check"></i> Request barangay documents online</li>
                        <li><i class="fas fa-check"></i> Receive important announcements and updates</li>
                        <li><i class="fas fa-check"></i> Participate in barangay activities and programs</li>
                        <li><i class="fas fa-check"></i> Access to government assistance programs</li>
                        <li><i class="fas fa-check"></i> Faster transaction processing</li>
                    </ul>
                </div>
                
                <div class="card process-card">
                    <h4><i class="fas fa-road" aria-hidden="true"></i> Registration Process</h4>
                    <ol class="process-list">
                        <li><strong>Personal Information</strong> - Basic details and account setup</li>
                        <li><strong>Household Information</strong> - Family and residence details</li>
                        <li><strong>Document Upload</strong> - Submit required identification</li>
                        <li><strong>Face Verification</strong> - Biometric identity confirmation</li>
                        <li><strong>Completion</strong> - Review and receive control number</li>
                    </ol>
                </div>

                <div class="security-notice">
                    <h4><i class="fas fa-shield-alt" aria-hidden="true"></i> Security Notice</h4>
                    <p>Your information is protected with bank-level encryption. We never share your data with third parties without your consent.</p>
                </div>
                
                <div class="sidebar-footer">
                    <p><i class="fas fa-clock"></i> Average completion time: <strong>8-10 minutes</strong></p>
                    <p><i class="fas fa-question-circle"></i> Need help? <a href="#contact">Contact Support</a></p>
                </div>
            </aside>
        </div>
    </div>
    
    <!-- Terms and Conditions Modal -->
    <div class="modal" id="termsModal" role="dialog" aria-labelledby="termsModalTitle" aria-modal="true" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="termsModalTitle">Terms and Conditions Agreement</h2>
                <button class="close-modal" id="closeTermsModal" aria-label="Close terms and conditions">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
            
            <div class="terms-content">
                <div class="terms-intro">
                    <p><strong>Last Updated:</strong> January 1, 2025</p>
                    <p>These Terms and Conditions ("Terms") govern your use of the Barangay 118 Online System website www.barangay118.gov.ph ("the Website") and the services provided therein.</p>
                </div>
                
                <h2>1. Privacy and Data Protection</h2>
                <p>Your privacy is important to us. By using the Website, you consent to the collection, use, and disclosure of your personal information as described in our Privacy Policy.</p>
                
                <h2>2. Collection of Personal Information</h2>
                <p>In order to access certain features or services on the Website, you may be required to provide personal information such as your name, birthdate, address, identification documents, and biometric data for verification purposes.</p>
                
                <h2>3. Use of Personal Information</h2>
                <p>The personal information we collect may be used for the following purposes:</p>
                <ul>
                    <li>To provide and maintain our barangay services</li>
                    <li>To verify your identity and eligibility for barangay services</li>
                    <li>To communicate with you about your account or transactions</li>
                    <li>To send you important updates, announcements, and emergency alerts</li>
                    <li>To improve our services and user experience</li>
                    <li>To comply with legal obligations and government requirements</li>
                </ul>
                
                <h2>4. Data Retention and Security</h2>
                <p>We will retain your personal information for as long as necessary to fulfill the purposes outlined in these Terms, unless a longer retention period is required or permitted by law. We implement appropriate security measures to protect your personal information.</p>
                
                <h2>5. User Responsibilities</h2>
                <p>As a user of the Website, you agree to:</p>
                <ul>
                    <li>Provide accurate and complete information during registration</li>
                    <li>Keep your login credentials secure and confidential</li>
                    <li>Notify us immediately of any unauthorized use of your account</li>
                    <li>Use the Website in compliance with all applicable laws and regulations</li>
                    <li>Not attempt to circumvent any security measures</li>
                </ul>
                
                <h2>6. Service Availability</h2>
                <p>We strive to maintain the availability of our services but do not guarantee uninterrupted access. We may perform maintenance and updates that temporarily affect service availability.</p>
                
                <h2>7. Limitation of Liability</h2>
                <p>Barangay 118 shall not be liable for any indirect, incidental, special, consequential, or punitive damages resulting from your use of or inability to use the services.</p>
                
                <p class="terms-acceptance">By using the Website, you acknowledge that you have read, understood, and agree to be bound by these Terms and our Privacy Policy.</p>
            </div>
            
            <div class="terms-options">
                <div class="terms-option">
                    <input type="radio" id="modal-decline" name="modal-terms" value="decline">
                    <label for="modal-decline">I Decline</label>
                </div>
                <div class="terms-option">
                    <input type="radio" id="modal-accept" name="modal-terms" value="accept">
                    <label for="modal-accept">I Accept Terms & Conditions</label>
                </div>
            </div>

            <div class="error-message" id="modal-terms-error" role="alert" aria-live="polite" style="display: none;">You must accept the terms and conditions to proceed with registration</div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-prev" id="cancelTerms" aria-label="Cancel registration">
                    Cancel Registration
                </button>
                <button type="button" class="btn btn-next" id="confirmTerms" aria-label="Confirm acceptance and proceed">
                    Confirm & Proceed
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;" aria-live="polite" aria-label="Processing your request">
        <div class="loading-spinner"></div>
        <p>Processing your registration...</p>
    </div>

    <!-- Dynamic Footer Placeholder - Controlled by PanelAdmin.html -->
    <div id="dynamic-footer-placeholder"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAEbKLcaRnMeujiQ2XWx8f5TqTlTC71c0w",
            authDomain: "barangay118-website.firebaseapp.com",
            databaseURL: "https://barangay118-website-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "barangay118-website",
            storageBucket: "barangay118-website.firebasestorage.app",
            messagingSenderId: "255746664706",
            appId: "1:255746664706:web:61d9cd618960147ef6ba1b",
            measurementId: "G-CQFZYJED7Z"
        };

        // Initialize Firebase
        let db = null;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.database();
            console.log("Firebase initialized successfully!");
        } catch (e) {
            console.error('Firebase initialization error:', e);
        }

        // Main variables
        let currentStep = 1;
        let currentOTP = null;
        let emailVerified = false;
        let otpExpiry = null;
        let countdownInterval = null;
        let capturedFaces = {
            front: false,
            left: false,
            right: false,
            closed: false
        };
        let webcamStream = null;
        let formData = {
            personalInfo: {},
            householdInfo: {},
            documents: {},
            faceCaptures: {},
            accountInfo: {}
        };

        // DOM helper functions
        function getEl(id) { return document.getElementById(id) || null; }
        function getVal(id) { const el = getEl(id); return el ? (el.value ?? '') : ''; }
        function setVal(id, value) { const el = getEl(id); if (el) el.value = value; }
        function toggleDisplay(id, display) { const el = getEl(id); if (el) el.style.display = display; }
        function exists(id) { return !!getEl(id); }

        // Initialize EmailJS
        (function(){
            try {
                if (typeof emailjs !== 'undefined' && emailjs.init) {
                    emailjs.init("KkQSfG62Jg8W8uies");
                    console.log("EmailJS initialized successfully");
                } else {
                    console.warn('EmailJS not available in this context.');
                }
            } catch (e) {
                console.error('Failed to init EmailJS:', e);
            }
        })();

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Load dynamic header and footer from Firebase
            loadDynamicContent();
            
            updateProgress();
            setupEventListeners();
            setupOtherInputs();
            setupFileUploads();
            setupPhoneFormatting();
            loadSavedData();
            
            // Add real-time validation for Middle Name
            const middleNameInput = getEl('middleName');
            if (middleNameInput) {
                middleNameInput.addEventListener('input', function() {
                    validateMiddleName();
                });
                middleNameInput.addEventListener('blur', function() {
                    validateMiddleName();
                });
            }
            
            // Set estimated date on step 5
            const estimatedDateEl = getEl('estimated-date');
            if (estimatedDateEl) {
                const today = new Date();
                const estimatedDate = new Date(today);
                estimatedDate.setDate(today.getDate() + 3);
                estimatedDateEl.textContent = estimatedDate.toLocaleDateString('en-PH', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
        });

        // Load dynamic header and footer from Firebase
        function loadDynamicContent() {
            if (!db) {
                console.warn('Firebase not initialized. Using default header and footer.');
                loadDefaultHeaderAndFooter();
                return;
            }

            const mainRef = db.ref('01_main');
            mainRef.once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // Build and set header
                    const headerHTML = buildHeader(data);
                    document.getElementById('dynamic-header-placeholder').innerHTML = headerHTML;

                    // Build and set footer
                    const footerHTML = buildFooter(data);
                    document.getElementById('dynamic-footer-placeholder').innerHTML = footerHTML;
                    
                    console.log('Dynamic content loaded from Firebase');
                } else {
                    loadDefaultHeaderAndFooter();
                }
            }).catch((error) => {
                console.error('Error loading dynamic content:', error);
                loadDefaultHeaderAndFooter();
            });
        }

        function loadDefaultHeaderAndFooter() {
            // We can use the same build functions with an empty object to get defaults
            const defaultData = {};
            const headerHTML = buildHeader(defaultData);
            document.getElementById('dynamic-header-placeholder').innerHTML = headerHTML;

            const footerHTML = buildFooter(defaultData);
            document.getElementById('dynamic-footer-placeholder').innerHTML = footerHTML;
            
            console.log('Using default header and footer');
        }

        // Build Header HTML from Firebase data
        function buildHeader(data) {
            const systemName = data['01_systemName'] || 'BARANGAY 118 ONLINE SYSTEM';
            const heroData = data['02_hero'] || {};
            const logoUrl = heroData.headerLogo || 'Logo-Favicon-removebg-preview.png';

            return `
                <header>
                    <div class="container">
                        <div class="navbar">
                            <!-- LOGO -->
                            <a href="index.html" id="home-logo" class="logo" aria-label="Barangay 118 Online System Home">
                                <img src="${logoUrl}"
                                    alt="Barangay 118 Official Logo"
                                    class="logo-image"
                                    width="70"
                                    height="70">
                                <h1 id="system-name">${systemName}</h1>
                            </a>

                            <!-- NAVIGATION -->
                            <nav class="nav-links" aria-label="Main navigation">
                                <a href="index.html" aria-label="Home page">
                                    <i class="fas fa-home" aria-hidden="true"></i>
                                    <span>Home</span>
                                </a>
                                <a href="AboutUs.html" aria-label="About Barangay 118 page">
                                    <i class="fas fa-info-circle" aria-hidden="true"></i>
                                    <span>About Us</span>
                                </a>
                                <a href="News.html" aria-label="Barangay News page">
                                    <i class="fas fa-newspaper" aria-hidden="true"></i>
                                    <span>News</span>
                                </a>
                                <a href="Emergency.html" aria-label="Barangay Emergency page">
                                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                                    <span>Emergency</span>
                                </a>
                                <a href="CreateAnAccount.html" class="active" aria-label="Create an account page">
                                    <i class="fas fa-user-plus" aria-hidden="true"></i>
                                    <span>Create Account</span>
                                </a>
                                <a href="LogIn.html" aria-label="Login page">
                                    <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                                    <span>Login</span>
                                </a>
                            </nav>
                        </div>
                    </div>
                </header>
            `;
        }

        // Build Footer HTML from Firebase data
        function buildFooter(data) {
            const footerData = data['04_footer'] || {};
            const title = footerData['title'] || 'Barangay 118 Online System';
            const description = footerData['description'] || 'Secure and efficient online services for Barangay 118. Connecting our community through technology.';
            const contactInfo = footerData['contactInfo'] || {};
            const socialMedia = footerData['socialMedia'] || {};
            const copyright = footerData['copyright'] || '&copy; 2025 Barangay 118 Online System. All Rights Reserved.';

            return `
                <footer id="footer">
                    <div class="container" id="footer-container">
                        <div class="footer-content" id="footer-content">

                            <!-- Left Column: System Info -->
                            <div class="footer-column" id="footer-system-column">
                                <h3 id="footer-title" class="footer-title">
                                    ${title}
                                </h3>
                                <p id="footer-description" class="footer-description">
                                    ${description}
                                </p>
                            </div>

                            <!-- Center Footer -->
                            <div class="footer-center" id="footer-center">
                                <div class="footer-row" id="footer-row">

                                    <!-- Contact Info -->
                                    <div class="footer-column" id="footer-contact-column">
                                        <h3 id="footer-contact-title">Contact Info</h3>

                                        <ul id="footer-contact-info" class="footer-contact-info">
                                            <li>
                                                <i class="fas fa-map-marker-alt"></i>
                                                <span id="footer-address-line1">
                                                    ${contactInfo['addressLine1'] || '402 2nd St, Grace Park East, Caloocan'}
                                                </span>
                                            </li>
                                            <li>
                                                <i class="fas fa-map-pin"></i>
                                                <span id="footer-address-line2">
                                                    ${contactInfo['addressLine2'] || 'Metro Manila, Philippines'}
                                                </span>
                                            </li>
                                            <li>
                                                <i class="fas fa-phone"></i>
                                                <span id="footer-phone">
                                                    ${contactInfo['phone'] || '(02) 8123-4567'}
                                                </span>
                                            </li>
                                            <li>
                                                <i class="fas fa-envelope"></i>
                                                <span id="footer-email">
                                                    ${contactInfo['email'] || 'info@barangay118.gov.ph'}
                                                </span>
                                            </li>
                                            <li>
                                                <i class="fas fa-clock"></i>
                                                <span id="footer-office-hours">
                                                    ${contactInfo['officeHours'] || 'Mon–Fri: 8:00 AM – 5:00 PM'}
                                                </span>
                                            </li>
                                        </ul>
                                    </div>

                                    <!-- Social / Links -->
                                    <div class="footer-column" id="footer-links-column">
                                        <h3 id="footer-social-title">Follow Us</h3>

                                        <ul class="footer-links" id="footer-social-links">
                                            <li id="footer-facebook-item">
                                                <i class="fab fa-facebook"></i>
                                                <a
                                                    id="footer-facebook-link"
                                                    href="${socialMedia['facebook'] || 'https://facebook.com/barangay118'}"
                                                    target="_blank"
                                                >
                                                    <span id="footer-facebook-text">
                                                        Barangay 118 Facebook
                                                    </span>
                                                </a>
                                            </li>

                                            <li id="footer-messenger-item">
                                                <i class="fab fa-facebook-messenger"></i>
                                                <a
                                                    id="footer-messenger-link"
                                                    href="${socialMedia['messenger'] || 'https://m.me/barangay118'}"
                                                    target="_blank"
                                                >
                                                    <span id="footer-messenger-text">
                                                        Messenger Chat
                                                    </span>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>

                                </div>
                            </div>

                        </div>

                        <!-- Copyright -->
                        <div class="copyright" id="footer-copyright">
                            <p id="copyright-text">
                                ${copyright}
                            </p>
                        </div>
                    </div>
                </footer>
            `;
        }

        // Validate Middle Name in real-time
        function validateMiddleName() {
            const middleName = getEl('middleName');
            const middleNameError = getEl('middleName-error');
            
            if (!middleName || !middleNameError) return;
            
            const value = middleName.value.trim();
            
            if (value === '') {
                middleName.classList.remove('success');
                middleName.classList.remove('error');
                middleNameError.style.display = 'none';
                return;
            }
            
            if (value.length > 0 && (value.toLowerCase() === 'n/a' || value.length >= 2)) {
                middleName.classList.add('success');
                middleName.classList.remove('error');
                middleNameError.style.display = 'none';
            } else {
                middleName.classList.remove('success');
                middleName.classList.add('error');
                middleNameError.style.display = 'block';
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Navigation buttons
            document.querySelectorAll('.btn-next').forEach(button => {
                if (button) button.addEventListener('click', handleNextStep);
            });
            document.querySelectorAll('.btn-prev').forEach(button => {
                if (button) button.addEventListener('click', handlePrevStep);
            });

            // Terms and Conditions modal
            if (exists('show-terms-btn')) getEl('show-terms-btn').addEventListener('click', showTermsModal);
            if (exists('closeTermsModal')) getEl('closeTermsModal').addEventListener('click', closeTermsModal);
            if (exists('cancelTerms')) getEl('cancelTerms').addEventListener('click', closeTermsModal);
            if (exists('confirmTerms')) getEl('confirmTerms').addEventListener('click', confirmTerms);

            // OTP functionality
            if (exists('send-otp')) getEl('send-otp').addEventListener('click', sendOTP);
            if (exists('verify-otp-btn')) getEl('verify-otp-btn').addEventListener('click', verifyOTP);
            if (exists('resend-otp')) getEl('resend-otp').addEventListener('click', sendOTP);

            // Password visibility toggle
            if (exists('togglePassword')) getEl('togglePassword').addEventListener('click', togglePasswordVisibility);
            if (exists('toggleConfirmPassword')) getEl('toggleConfirmPassword').addEventListener('click', toggleConfirmPasswordVisibility);

            // Real-time validation
            if (exists('password')) getEl('password').addEventListener('input', validatePassword);
            if (exists('confirmPassword')) getEl('confirmPassword').addEventListener('input', validatePasswordConfirmation);
            if (exists('dateOfBirth')) getEl('dateOfBirth').addEventListener('change', calculateAge);

            // Webcam functionality
            if (exists('startWebcam')) getEl('startWebcam').addEventListener('click', startWebcam);
            if (exists('captureImage')) getEl('captureImage').addEventListener('click', captureImage);
            if (exists('retakeImage')) getEl('retakeImage').addEventListener('click', retakeImage);

            // Face capture buttons
            ['front','left','right','closed'].forEach(face => {
                const btnId = `capture-${face}`;
                if (exists(btnId)) getEl(btnId).addEventListener('click', () => captureFace(face));
            });

            // Retake face buttons
            document.querySelectorAll('.retake-face-btn').forEach(btn => {
                if (!btn) return;
                btn.addEventListener('click', function() {
                    const faceType = this.getAttribute('data-face');
                    if (faceType) retakeFaceCapture(faceType);
                });
            });

            // File upload for ID documents
            if (exists('idFront')) getEl('idFront').addEventListener('change', () => handleIdFileUpload('front'));
            if (exists('idBack')) getEl('idBack').addEventListener('change', () => handleIdFileUpload('back'));

            // File deletion buttons for ID documents
            if (exists('deleteIdFront')) getEl('deleteIdFront').addEventListener('click', () => deleteFile('idFront'));
            if (exists('deleteIdBack')) getEl('deleteIdBack').addEventListener('click', () => deleteFile('idBack'));

            // Return to home button
            if (exists('returnToHome')) getEl('returnToHome').addEventListener('click', returnToHome);

            // Print confirmation button
            if (exists('printConfirmation')) getEl('printConfirmation').addEventListener('click', printConfirmation);

            // Copy control number button
            if (exists('copy-control-number')) getEl('copy-control-number').addEventListener('click', copyControlNumber);

            // Citizenship and occupation dropdowns
            if (exists('citizenship')) getEl('citizenship').addEventListener('change', function() {
                toggleOtherInput(this, 'otherCitizenship');
            });
            if (exists('occupation')) getEl('occupation').addEventListener('change', function() {
                toggleOtherInput(this, 'otherOccupation');
            });

            // Extension name toggle
            if (exists('extName')) getEl('extName').addEventListener('change', function() {
                toggleOtherExt(this);
            });

            // Auto-save on input changes
            setupAutoSave();

            // Add real-time validation
            setupRealTimeValidation();
            
            // Direct step navigation
            window.showStepDirect = function(step) {
                if (step >= 1 && step <= 5) {
                    if (validateCurrentStep()) {
                        showStep(step);
                        updateProgress();
                    }
                }
            };
        }

        // Real-time validation for Step 1 fields
        function setupRealTimeValidation() {
            const requiredFields = [
                'lastName', 'firstName', 'gender', 'dateOfBirth', 'address',
                'placeOfBirth', 'age', 'phone', 'civilStatus', 'citizenship',
                'occupation', 'email', 'password', 'confirmPassword'
            ];

            requiredFields.forEach(fieldId => {
                const field = getEl(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        validateSingleField(fieldId);
                    });
                    field.addEventListener('blur', function() {
                        validateSingleField(fieldId);
                    });
                }
            });

            // Dropdowns: change event
            ['gender', 'civilStatus', 'citizenship', 'occupation'].forEach(dropdownId => {
                const dropdown = getEl(dropdownId);
                if (dropdown) dropdown.addEventListener('change', function() {
                    validateSingleField(dropdownId);
                });
            });

            const extName = getEl('extName');
            if (extName) extName.addEventListener('change', function() { validateSingleField('extName'); });
        }

        // Validate a single field in real-time
        function validateSingleField(fieldId) {
            const field = getEl(fieldId);
            const errorElement = getEl(`${fieldId}-error`);
            if (!field || !errorElement) return;

            let isValid = true;
            let errorMessage = '';

            switch(fieldId) {
                case 'lastName':
                case 'firstName':
                case 'address':
                case 'placeOfBirth':
                    isValid = field.value.trim().length > 0;
                    errorMessage = `Please enter your ${fieldId.replace(/([A-Z])/g, ' $1').toLowerCase()}`;
                    break;

                case 'gender':
                case 'civilStatus':
                case 'citizenship':
                case 'occupation':
                    isValid = field.value !== '';
                    errorMessage = `Please select your ${fieldId.replace(/([A-Z])/g, ' $1').toLowerCase()}`;
                    break;

                case 'dateOfBirth':
                    isValid = field.value !== '';
                    errorMessage = 'Please enter your date of birth';
                    if (field.value) {
                        const dob = new Date(field.value);
                        const today = new Date();
                        let age = today.getFullYear() - dob.getFullYear();
                        const monthDiff = today.getMonth() - dob.getMonth();
                        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) age--;
                        if (age < 18) {
                            isValid = false;
                            errorMessage = 'You must be at least 18 years old to register';
                        }
                    }
                    break;

                case 'age':
                    isValid = field.value !== '' && parseInt(field.value, 10) >= 18;
                    errorMessage = 'Please enter a valid age (must be at least 18)';
                    break;

                case 'phone':
                    {
                        const phoneRegex = /^\+63\s?9\d{2}[- ]?\d{3}[- ]?\d{4}$/;
                        isValid = phoneRegex.test(field.value);
                        errorMessage = 'Please enter a valid Philippine phone number starting with +63';
                    }
                    break;

                case 'email':
                    {
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        isValid = emailRegex.test(field.value);
                        errorMessage = 'Please enter a valid email address';

                        const emailSuccess = getEl('email-success');
                        if (emailSuccess) {
                            if (isValid) {
                                emailSuccess.style.display = 'block';
                                if (getEl('send-otp')) getEl('send-otp').disabled = false;
                            } else {
                                emailSuccess.style.display = 'none';
                                if (getEl('send-otp')) getEl('send-otp').disabled = true;
                            }
                        }

                        // Reset OTP verification if email changes
                        if (emailVerified) resetOTPVerification();
                    }
                    break;

                case 'password':
                    isValid = validatePasswordStrength(field.value);
                    if (isValid) updatePasswordRequirements(field.value);
                    break;

                case 'confirmPassword':
                    {
                        const password = getVal('password');
                        isValid = field.value === password && field.value !== '';
                        errorMessage = 'Passwords do not match';
                        const matchMessage = getEl('password-match-message');
                        if (matchMessage) {
                            matchMessage.style.display = isValid ? 'block' : 'none';
                        }
                    }
                    break;

                case 'extName':
                    {
                        const otherExt = getEl('otherExt');
                        isValid = field.value !== '' || (otherExt && otherExt.value.trim() !== '');
                        errorMessage = 'Please select or specify your extension name';
                    }
                    break;
            }

            if (isValid) {
                field.classList.remove('error');
                field.classList.add('success');
                errorElement.style.display = 'none';
            } else {
                field.classList.add('error');
                field.classList.remove('success');
                if (field.value.trim() !== '') {
                    errorElement.textContent = errorMessage;
                    errorElement.style.display = 'block';
                } else {
                    errorElement.style.display = 'none';
                }
            }
        }

        // Enhanced password strength validation
        function validatePasswordStrength(password) {
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            const hasSpecialChar = /[@_><,?]/.test(password);
            const isLongEnough = password.length >= 10;
            return hasUpperCase && hasLowerCase && hasNumbers && hasSpecialChar && isLongEnough;
        }

        // Update password requirements in real-time
        function updatePasswordRequirements(password) {
            const requirements = {
                'req-length': password.length >= 10,
                'req-uppercase': /[A-Z]/.test(password),
                'req-lowercase': /[a-z]/.test(password),
                'req-number': /\d/.test(password),
                'req-special': /[@_><,?]/.test(password)
            };

            Object.keys(requirements).forEach(reqId => {
                const element = getEl(reqId);
                if (!element) return;
                if (requirements[reqId]) {
                    element.classList.remove('invalid');
                    element.classList.add('valid');
                } else {
                    element.classList.remove('valid');
                    element.classList.add('invalid');
                }
            });
        }

        // Auto-save functionality (debounced)
        function setupAutoSave() {
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (!input) return;
                input.addEventListener('change', saveFormData);
                input.addEventListener('input', debounce(saveFormData, 1000));
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Save form data to localStorage
        function saveFormData() {
            const data = collectFormData();
            try {
                localStorage.setItem('barangayRegistrationData', JSON.stringify(data));
                localStorage.setItem('barangayRegistrationCurrentStep', currentStep.toString());
            } catch (e) {
                console.error('Failed saving to localStorage:', e);
            }
        }

        // Load saved data from localStorage
        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('barangayRegistrationData');
                const savedStep = localStorage.getItem('barangayRegistrationCurrentStep');

                if (savedData) {
                    const data = JSON.parse(savedData);
                    populateFormData(data);
                }

                if (savedStep) {
                    currentStep = parseInt(savedStep, 10) || 1;
                    showStep(currentStep);
                    updateProgress();
                }
            } catch (e) {
                console.error('Failed to load saved data:', e);
            }
        }

        // Helper to collect file preview src
        function getPreviewSrc(previewId) {
            const img = getEl(previewId);
            return (img && img.src) ? img.src : '';
        }

        // Collect all form data
        function collectFormData() {
            return {
                personalInfo: {
                    lastName: getVal('lastName'),
                    firstName: getVal('firstName'),
                    middleName: getVal('middleName'),
                    extName: getVal('extName'),
                    otherExt: getVal('otherExt'),
                    gender: getVal('gender'),
                    dateOfBirth: getVal('dateOfBirth'),
                    address: getVal('address'),
                    placeOfBirth: getVal('placeOfBirth'),
                    age: getVal('age'),
                    phone: getVal('phone'),
                    civilStatus: getVal('civilStatus'),
                    citizenship: getVal('citizenship'),
                    otherCitizenship: getVal('otherCitizenship'),
                    occupation: getVal('occupation'),
                    otherOccupation: getVal('otherOccupation'),
                    specialCategories: getSelectedCategories()
                },
                accountInfo: {
                    email: getVal('email'),
                    password: getVal('password'),
                    emailVerified: emailVerified
                },
                householdInfo: {
                    householdMembers: getVal('householdMembers'),
                    ownerName: getVal('ownerName'),
                    precinctNo: getVal('precinctNo'),
                    yearsInBarangay: getVal('yearsInBarangay')
                },
                documents: {
                    idType: getVal('idType'),
                    userReason: getVal('userReason'),
                    idFrontPreviewSrc: getPreviewSrc('idFrontImagePreview'),
                    idBackPreviewSrc: getPreviewSrc('idBackImagePreview')
                },
                faceCaptures: {
                    flags: { ...capturedFaces },
                    frontPreview: getPreviewSrc('frontFacePreview'),
                    leftPreview: getPreviewSrc('leftFacePreview'),
                    rightPreview: getPreviewSrc('rightFacePreview'),
                    closedPreview: getPreviewSrc('closedFacePreview')
                },
                currentStep: currentStep
            };
        }

        // Populate form with saved data
        function populateFormData(data) {
            if (!data) return;

            // Personal Info
            if (data.personalInfo) {
                setVal('lastName', data.personalInfo.lastName || '');
                setVal('firstName', data.personalInfo.firstName || '');
                setVal('middleName', data.personalInfo.middleName || '');
                setVal('extName', data.personalInfo.extName || '');
                setVal('otherExt', data.personalInfo.otherExt || '');
                setVal('gender', data.personalInfo.gender || '');
                setVal('dateOfBirth', data.personalInfo.dateOfBirth || '');
                setVal('address', data.personalInfo.address || '');
                setVal('placeOfBirth', data.personalInfo.placeOfBirth || '');
                setVal('age', data.personalInfo.age || '');
                setVal('phone', data.personalInfo.phone || '');
                setVal('civilStatus', data.personalInfo.civilStatus || '');
                setVal('citizenship', data.personalInfo.citizenship || '');
                setVal('otherCitizenship', data.personalInfo.otherCitizenship || '');
                setVal('occupation', data.personalInfo.occupation || '');
                setVal('otherOccupation', data.personalInfo.otherOccupation || '');
                if (Array.isArray(data.personalInfo.specialCategories)) {
                    data.personalInfo.specialCategories.forEach(category => {
                        const checkbox = document.querySelector(`input[name="indicateIf[]"][value="${category}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            }

            // Account Info
            if (data.accountInfo) {
                setVal('email', data.accountInfo.email || '');
                setVal('password', data.accountInfo.password || '');
                emailVerified = !!data.accountInfo.emailVerified;
                if (emailVerified && exists('otp-success')) {
                    getEl('otp-success').style.display = 'block';
                    if (exists('email')) getEl('email').disabled = true;
                    if (exists('send-otp')) getEl('send-otp').disabled = true;
                }
            }

            // Household Info
            if (data.householdInfo) {
                setVal('householdMembers', data.householdInfo.householdMembers || '');
                setVal('ownerName', data.householdInfo.ownerName || '');
                setVal('precinctNo', data.householdInfo.precinctNo || '');
                setVal('yearsInBarangay', data.householdInfo.yearsInBarangay || '');
            }

            // Documents previews
            if (data.documents) {
                if (data.documents.idFrontPreviewSrc && exists('idFrontImagePreview')) {
                    getEl('idFrontImagePreview').src = data.documents.idFrontPreviewSrc;
                    if (exists('idFrontPreviewContainer')) getEl('idFrontPreviewContainer').style.display = 'block';
                }
                if (data.documents.idBackPreviewSrc && exists('idBackImagePreview')) {
                    getEl('idBackImagePreview').src = data.documents.idBackPreviewSrc;
                    if (exists('idBackPreviewContainer')) getEl('idBackPreviewContainer').style.display = 'block';
                }

                setVal('idType', data.documents.idType || '');
                setVal('userReason', data.documents.userReason || '');
            }

            // Face Captures
            if (data.faceCaptures) {
                if (data.faceCaptures.flags) capturedFaces = { ...capturedFaces, ...data.faceCaptures.flags };
                if (data.faceCaptures.frontPreview && exists('frontFacePreview')) {
                    getEl('frontFacePreview').src = data.faceCaptures.frontPreview;
                    getEl('frontFacePreview').style.display = 'block';
                }
                if (data.faceCaptures.leftPreview && exists('leftFacePreview')) {
                    getEl('leftFacePreview').src = data.faceCaptures.leftPreview;
                    getEl('leftFacePreview').style.display = 'block';
                }
                if (data.faceCaptures.rightPreview && exists('rightFacePreview')) {
                    getEl('rightFacePreview').src = data.faceCaptures.rightPreview;
                    getEl('rightFacePreview').style.display = 'block';
                }
                if (data.faceCaptures.closedPreview && exists('closedFacePreview')) {
                    getEl('closedFacePreview').src = data.faceCaptures.closedPreview;
                    getEl('closedFacePreview').style.display = 'block';
                }

                updateFaceCaptureUI();
            }
        }

        // Update face capture UI based on saved data
        function updateFaceCaptureUI() {
            Object.keys(capturedFaces).forEach(faceType => {
                if (capturedFaces[faceType]) {
                    const stepElement = getEl(`step-${faceType}`);
                    const preview = getEl(`${faceType}FacePreview`);
                    const retakeBtn = document.querySelector(`.retake-face-btn[data-face="${faceType}"]`);

                    if (stepElement) {
                        stepElement.classList.remove('active');
                        stepElement.classList.add('completed');
                    }
                    if (preview) preview.style.display = 'block';
                    if (retakeBtn) retakeBtn.style.display = 'block';
                }
            });

            updateFaceProgressFromSaved();
            checkAllFacesCaptured();
        }

        function updateFaceProgressFromSaved() {
            const angles = ['front', 'left', 'right', 'closed'];
            let lastCompletedIndex = -1;

            angles.forEach((angle, index) => {
                if (capturedFaces[angle]) lastCompletedIndex = index;
            });

            for (let i = 0; i < angles.length; i++) {
                const progressCircle = getEl(`progress-${angles[i]}`);
                const connector = getEl(`connector-${i+1}`);

                if (progressCircle && i <= lastCompletedIndex) progressCircle.classList.add('completed');
                if (connector && i <= lastCompletedIndex - 1) connector.classList.add('completed');

                if (i === lastCompletedIndex + 1) {
                    if (progressCircle) progressCircle.classList.add('active');
                    updateInstructions(angles[i]);
                }
            }
        }

        // Phone number formatting
        function setupPhoneFormatting() {
            const phoneInput = getEl('phone');
            if (!phoneInput) return;

            if (!phoneInput.value || !phoneInput.value.trim()) phoneInput.value = '+63 ';

            phoneInput.addEventListener('input', function() {
                let value = this.value.replace(/\D/g, '');
                if (value.startsWith('63')) value = value.substring(2);
                let formatted = '+63 ';
                if (value.length > 0) formatted += value.substring(0, 3);
                if (value.length > 3) formatted += '-' + value.substring(3, 6);
                if (value.length > 6) formatted += '-' + value.substring(6, 10);
                this.value = formatted;
            });

            phoneInput.addEventListener('keydown', function(e) {
                const cursorPos = this.selectionStart;
                if (e.key.length === 1 || ['Backspace','Delete','ArrowLeft','ArrowRight','Tab'].includes(e.key)) {
                    // allow
                }
                if ((e.key === 'Backspace' || e.key === 'Delete') && cursorPos <= 4) {
                    e.preventDefault();
                    return;
                }
            });

            phoneInput.addEventListener('blur', function() {
                if (!this.value.startsWith('+63')) {
                    let numbers = this.value.replace(/\D/g, '');
                    if (numbers.startsWith('63')) numbers = numbers.substring(2);
                    this.value = '+63 ' + numbers.substring(0, 10);
                }
            });

            phoneInput.addEventListener('focus', function() {
                const len = this.value.length;
                this.setSelectionRange(len, len);
            });
        }

        // OTP Functions
        async function sendOTP() {
            const email = getVal('email').trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email || !emailRegex.test(email)) {
                showError('email-error', 'Please enter a valid email address first');
                return;
            }

            const btn = getEl('send-otp');
            const resendBtn = getEl('resend-otp');
            if (btn) { btn.disabled = true; btn.classList.add('loading'); btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...'; }
            if (resendBtn) resendBtn.disabled = true;

            try {
                currentOTP = Math.floor(100000 + Math.random() * 900000).toString();
                otpExpiry = Date.now() + 5 * 60 * 1000;

                const templateParams = {
                    to_email: email,
                    user_email: email,
                    email: email,
                    otp_code: currentOTP,
                    from_name: 'Barangay 118 Online System',
                    message: `Your OTP verification code is: ${currentOTP}. This code will expire in 5 minutes.`,
                    user_name: getVal('firstName') || 'User'
                };

                if (typeof emailjs === 'undefined' || !emailjs.send) {
                    throw new Error('EmailJS is not available. OTP cannot be sent in this environment.');
                }

                console.log('Sending OTP email:', templateParams);
                
                // Use the correct EmailJS service and template IDs
                const response = await emailjs.send(
                    'service_y0sh9nd', 
                    'template_vdbhhq5', 
                    templateParams
                );
                
                console.log('Email sent successfully:', response);
                showToast('OTP has been sent to your email! Please check your inbox.', 'success');

                if (exists('otp-input-group')) getEl('otp-input-group').style.display = 'block';
                if (exists('otp-resend')) getEl('otp-resend').style.display = 'block';
                if (exists('otp-countdown')) getEl('otp-countdown').style.display = 'block';

                startCountdown(120);
                if (exists('otp-error')) getEl('otp-error').style.display = 'none';
                
                // Re-enable buttons after successful send
                if (btn) { 
                    btn.disabled = false; 
                    btn.classList.remove('loading'); 
                    btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send OTP'; 
                }
            } catch (error) {
                console.error('Failed to send OTP:', error);
                let errorMessage = 'Failed to send OTP. ';
                if (error.text) errorMessage += 'Error: ' + error.text;
                else errorMessage += 'Please check your email address and try again.';
                showToast(errorMessage, 'error');

                if (btn) { 
                    btn.disabled = false; 
                    btn.classList.remove('loading'); 
                    btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send OTP'; 
                }
                if (resendBtn) resendBtn.disabled = false;
            }
        }

        function startCountdown(seconds) {
            const countdownElement = getEl('countdown-timer');
            const sendBtn = getEl('send-otp');
            const resendBtn = getEl('resend-otp');

            if (countdownInterval) clearInterval(countdownInterval);
            if (sendBtn) sendBtn.disabled = true;
            if (resendBtn) resendBtn.disabled = true;

            countdownInterval = setInterval(() => {
                seconds--;
                if (countdownElement) countdownElement.textContent = seconds;
                if (seconds <= 0) {
                    clearInterval(countdownInterval);
                    if (sendBtn) { sendBtn.disabled = false; }
                    if (resendBtn) resendBtn.disabled = false;
                    if (getEl('otp-countdown')) getEl('otp-countdown').style.display = 'none';
                }
            }, 1000);
        }

        function verifyOTP() {
            const enteredOTP = getVal('otpInput').trim();
            const otpError = getEl('otp-error');
            const otpSuccess = getEl('otp-success');

            if (!currentOTP) {
                if (otpError) { otpError.textContent = 'Please request an OTP first.'; otpError.style.display = 'block'; }
                return;
            }

            if (Date.now() > otpExpiry) {
                if (otpError) { otpError.textContent = 'OTP has expired. Please request a new one.'; otpError.style.display = 'block'; }
                return;
            }

            if (enteredOTP === currentOTP) {
                if (otpError) otpError.style.display = 'none';
                if (otpSuccess) otpSuccess.style.display = 'block';
                emailVerified = true;

                if (getEl('email')) getEl('email').disabled = true;
                if (getEl('send-otp')) getEl('send-otp').disabled = true;
                if (getEl('verify-otp-btn')) getEl('verify-otp-btn').disabled = true;
                if (getEl('resend-otp')) getEl('resend-otp').disabled = true;
                if (getEl('otpInput')) getEl('otpInput').disabled = true;

                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    if (getEl('otp-countdown')) getEl('otp-countdown').style.display = 'none';
                }

                showToast('Email verified successfully!', 'success');
                saveFormData();
            } else {
                if (otpError) { otpError.textContent = 'Incorrect OTP. Please try again.'; otpError.style.display = 'block'; }
                if (otpSuccess) otpSuccess.style.display = 'none';
            }
        }

        function resetOTPVerification() {
            emailVerified = false;
            currentOTP = null;
            if (getEl('otp-success')) getEl('otp-success').style.display = 'none';
            if (getEl('email')) getEl('email').disabled = false;
            if (getEl('send-otp')) getEl('send-otp').disabled = false;
            if (getEl('verify-otp-btn')) getEl('verify-otp-btn').disabled = false;
            if (getEl('resend-otp')) getEl('resend-otp').disabled = false;
            if (getEl('otpInput')) getEl('otpInput').disabled = false;
            if (getEl('otp-input-group')) getEl('otp-input-group').style.display = 'none';
            if (getEl('otp-resend')) getEl('otp-resend').style.display = 'none';
            if (getEl('otp-countdown')) getEl('otp-countdown').style.display = 'none';
            if (countdownInterval) clearInterval(countdownInterval);
        }

        // File upload and deletion functions
        function setupFileUploads() {
            // Already set up in event listeners for ID documents
        }

        function handleIdFileUpload(side) {
            const fileInput = getEl(`id${side.charAt(0).toUpperCase() + side.slice(1)}`);
            if (!fileInput || !fileInput.files) return;
            const file = fileInput.files[0];

            if (!file) return;
            if (file.size > 5 * 1024 * 1024) {
                showToast('File size must be less than 5MB', 'error');
                fileInput.value = '';
                return;
            }

            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                showToast('Please upload only JPG, PNG, or PDF files', 'error');
                fileInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = getEl(`id${side.charAt(0).toUpperCase() + side.slice(1)}ImagePreview`);
                const container = getEl(`id${side.charAt(0).toUpperCase() + side.slice(1)}PreviewContainer`);

                if (file.type.includes('image') && preview) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    if (container) container.style.display = 'block';
                } else if (file.type === 'application/pdf' && container) {
                    container.innerHTML = `<i class="fas fa-file-pdf" style="font-size: 2rem; margin-bottom: 10px; color: #e74c3c;"></i><div>${file.name}</div>`;
                }

                showToast(`ID ${side} uploaded successfully!`, 'success');
                saveFormData();
            };
            reader.readAsDataURL(file);
        }

        function deleteFile(fileType) {
            let fileInput, preview, container;

            switch(fileType) {
                case 'idFront':
                    fileInput = getEl('idFront');
                    preview = getEl('idFrontImagePreview');
                    container = getEl('idFrontPreviewContainer');
                    break;
                case 'idBack':
                    fileInput = getEl('idBack');
                    preview = getEl('idBackImagePreview');
                    container = getEl('idBackPreviewContainer');
                    break;
            }

            if (fileInput) fileInput.value = '';
            if (preview) preview.style.display = 'none';
            if (container) {
                container.style.display = 'none';
                if (fileType === 'idFront' || fileType === 'idBack') {
                    container.innerHTML = `
                        <img id="${fileType}ImagePreview" class="image-preview" alt="Uploaded ${fileType} preview">
                        <button type="button" class="delete-file-btn" id="delete${fileType.charAt(0).toUpperCase() + fileType.slice(1)}" aria-label="Remove ${fileType} file">×</button>
                    `;
                    const delBtn = getEl(`delete${fileType.charAt(0).toUpperCase() + fileType.slice(1)}`);
                    if (delBtn) delBtn.addEventListener('click', () => deleteFile(fileType));
                }
            }

            showToast('File removed. You can upload a new one.', 'success');
            saveFormData();
        }

        // Enhanced Face Capture Functions
        function captureFace(angle) {
            const video = getEl('webcamVideo');
            const canvas = getEl('webcamCanvas');
            const preview = getEl(`${angle}FacePreview`);
            const retakeBtn = document.querySelector(`.retake-face-btn[data-face="${angle}"]`);

            if (!video || !video.srcObject) {
                showToast('Please start the camera first.', 'error');
                return;
            }

            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;

            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const previewCanvas = document.createElement('canvas');
            previewCanvas.width = 100;
            previewCanvas.height = 100;
            const previewContext = previewCanvas.getContext('2d');

            previewContext.beginPath();
            previewContext.arc(50, 50, 50, 0, Math.PI * 2, true);
            previewContext.closePath();
            previewContext.clip();

            previewContext.drawImage(canvas, 0, 0, canvas.width, canvas.height, 0, 0, 100, 100);

            if (preview) {
                preview.src = previewCanvas.toDataURL('image/png');
                preview.style.display = 'block';
            }
            if (retakeBtn) retakeBtn.style.display = 'block';

            capturedFaces[angle] = true;

            const stepElement = getEl(`step-${angle}`);
            if (stepElement) {
                stepElement.classList.remove('active');
                stepElement.classList.add('completed');
            }

            updateFaceProgress(angle);

            let nextAngle = '';
            if (angle === 'front') nextAngle = 'left';
            else if (angle === 'left') nextAngle = 'right';
            else if (angle === 'right') nextAngle = 'closed';

            if (nextAngle) {
                const nextStepElement = getEl(`step-${nextAngle}`);
                if (nextStepElement) nextStepElement.classList.add('active');
                if (getEl(`capture-${nextAngle}`)) getEl(`capture-${nextAngle}`).disabled = false;
                updateInstructions(nextAngle);
            }

            checkAllFacesCaptured();
            showToast(`${angle.charAt(0).toUpperCase() + angle.slice(1)} face captured successfully!`, 'success');
            saveFormData();
        }

        function checkAllFacesCaptured() {
            const allCaptured = Object.values(capturedFaces).every(val => val === true);
            if (allCaptured) {
                if (exists('completeFaceScan')) getEl('completeFaceScan').disabled = false;
                if (exists('face-status')) {
                    getEl('face-status').innerHTML = '<i class="fas fa-check-circle"></i> All face captures completed!';
                    getEl('face-status').classList.add('completed');
                }
                stopWebcam();
            }
        }

        function updateFaceProgress(currentAngle) {
            const angles = ['front', 'left', 'right', 'closed'];
            const currentIndex = angles.indexOf(currentAngle);
            for (let i = 0; i <= currentIndex; i++) {
                const progressCircle = getEl(`progress-${angles[i]}`);
                if (progressCircle) {
                    progressCircle.classList.add('completed');
                    if (i === currentIndex) {
                        progressCircle.classList.add('active');
                    } else {
                        progressCircle.classList.remove('active');
                    }
                }
            }
            for (let i = 0; i < currentIndex; i++) {
                const connector = getEl(`connector-${i+1}`);
                if (connector) connector.classList.add('completed');
            }
        }

        function updateInstructions(angle) {
            const instructions = getEl('face-instructions');
            const status = getEl('face-status');
            if (!instructions || !status) return;

            switch(angle) {
                case 'front':
                    instructions.textContent = 'Please look directly at the camera for the front face capture';
                    status.innerHTML = '<i class="fas fa-camera"></i> Ready for front face capture';
                    break;
                case 'left':
                    instructions.textContent = 'Please turn your head slightly to the left';
                    status.innerHTML = '<i class="fas fa-arrow-left"></i> Ready for left side capture';
                    break;
                case 'right':
                    instructions.textContent = 'Please turn your head slightly to the right';
                    status.innerHTML = '<i class="fas fa-arrow-right"></i> Ready for right side capture';
                    break;
                case 'closed':
                    instructions.textContent = 'Please close your eyes gently for the closed eyes capture';
                    status.innerHTML = '<i class="fas fa-eye-slash"></i> Ready for closed eyes capture';
                    break;
            }
        }

        // Enhanced retake
        function retakeFaceCapture(faceType) {
            if (!faceType) return;
            capturedFaces[faceType] = false;

            const preview = getEl(`${faceType}FacePreview`);
            const retakeBtn = document.querySelector(`.retake-face-btn[data-face="${faceType}"]`);
            if (preview) preview.style.display = 'none';
            if (retakeBtn) retakeBtn.style.display = 'none';

            const stepElement = getEl(`step-${faceType}`);
            if (stepElement) {
                stepElement.classList.add('active');
                stepElement.classList.remove('completed');
            }

            if (getEl(`capture-${faceType}`)) getEl(`capture-${faceType}`).disabled = false;
            if (exists('completeFaceScan')) getEl('completeFaceScan').disabled = true;

            updateProgressAfterRetake(faceType);
            updateInstructions(faceType);

            if (!webcamStream) startWebcam();

            showToast(`You can now retake the ${faceType} face photo.`, 'info');
            saveFormData();
        }

        function updateProgressAfterRetake(retakenAngle) {
            const angles = ['front', 'left', 'right', 'closed'];
            const retakenIndex = angles.indexOf(retakenAngle);

            for (let i = retakenIndex; i < angles.length; i++) {
                const progressCircle = getEl(`progress-${angles[i]}`);
                if (progressCircle) {
                    progressCircle.classList.remove('completed');
                    if (i === retakenIndex) progressCircle.classList.add('active');
                    else progressCircle.classList.remove('active');
                }
                if (i > 0) {
                    const connector = getEl(`connector-${i}`);
                    if (connector) connector.classList.remove('completed');
                }
            }
        }

        // Step navigation and helpers
        function showStep(step) {
            document.querySelectorAll('.form-section').forEach(section => {
                if (section) section.classList.remove('active');
            });

            const target = getEl(`step${step}`);
            if (target) target.classList.add('active');
        }

        function returnToHome() {
            // Save final registration data before leaving
            quickSaveRegistration();
            
            localStorage.removeItem('barangayRegistrationData');
            localStorage.removeItem('barangayRegistrationCurrentStep');
            localStorage.removeItem('barangayRegistrationControlNumber');

            showToast('Registration completed! Returning to home page...', 'success');
            setTimeout(() => {
                window.location.href = 'PanelUserView.html';
            }, 1200);
        }

        function printConfirmation() {
            window.print();
        }
        
        function copyControlNumber() {
            const controlNumber = getEl('controlNumber');
            if (!controlNumber) return;
            
            navigator.clipboard.writeText(controlNumber.textContent)
                .then(() => {
                    showToast('Control number copied to clipboard!', 'success');
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    showToast('Failed to copy control number', 'error');
                });
        }

        // Utility toast / error
        function showError(elementId, message) {
            const el = getEl(elementId);
            if (el) {
                el.textContent = message;
                el.style.display = 'block';
            } else {
                showToast(message, 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <div style="display:inline-block; margin-left:8px">${message}</div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.transform = 'translateX(0)'; toast.style.opacity = '1'; }, 10);
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                toast.style.opacity = '0';
                setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 300);
            }, 4500);
        }

        function getSelectedCategories() {
            const selected = [];
            document.querySelectorAll('input[name="indicateIf[]"]:checked').forEach(cb => {
                if (cb && cb.value) selected.push(cb.value);
            });
            return selected;
        }

        function setupOtherInputs() {
            const citizenshipSelect = getEl('citizenship');
            const occupationSelect = getEl('occupation');

            if (citizenshipSelect) citizenshipSelect.addEventListener('change', function() { toggleOtherInput(this, 'otherCitizenship'); });
            if (occupationSelect) occupationSelect.addEventListener('change', function() { toggleOtherInput(this, 'otherOccupation'); });
        }

        function toggleOtherInput(selectElement, otherInputId) {
            const otherInput = getEl(otherInputId);
            if (!selectElement || !otherInput) return;
            if (selectElement.value === "Other") {
                otherInput.style.display = "block";
                otherInput.required = true;
            } else {
                otherInput.style.display = "none";
                otherInput.required = false;
                otherInput.value = "";
            }
        }

        function toggleOtherExt(select) {
            const otherInput = getEl('otherExt');
            if (!select || !otherInput) return;
            if (select.value === 'Other') {
                otherInput.style.display = 'block';
                otherInput.required = true;
            } else {
                otherInput.style.display = 'none';
                otherInput.required = false;
                otherInput.value = '';
            }
        }

        // Update progress bar and step counter with accurate percentages
        function updateProgress() {
            const bar = getEl('progress-bar');
            if (bar) {
                const progress = ((currentStep - 1) / 4) * 100;
                bar.style.width = `${progress}%`;
                bar.setAttribute('aria-valuenow', progress);
            }

            if (getEl('current-step-number')) getEl('current-step-number').textContent = currentStep;
            const stepDescriptions = {
                1: '- Head of Family Information',
                2: '- Household Information',
                3: '- Document Upload',
                4: '- Face Verification',
                5: '- Completion'
            };
            if (getEl('step-description')) getEl('step-description').textContent = stepDescriptions[currentStep] || '';

            // Update step indicators with proper checkmarks
            for (let i = 1; i <= 5; i++) {
                const stepIndicator = getEl(`step${i}-indicator`);
                if (!stepIndicator) continue;
                
                const stepNumber = stepIndicator.querySelector('.step-number');
                if (!stepNumber) continue;
                
                if (i < currentStep) {
                    stepIndicator.classList.remove('active');
                    stepIndicator.classList.add('completed');
                    stepNumber.innerHTML = '';
                    stepNumber.innerHTML = '✓';
                } else if (i === currentStep) {
                    stepIndicator.classList.add('active');
                    stepIndicator.classList.remove('completed');
                    stepNumber.innerHTML = i;
                } else {
                    stepIndicator.classList.remove('active', 'completed');
                    stepNumber.innerHTML = i;
                }
            }
        }

        // Handle step buttons
        function handleNextStep(event) {
            const button = event.target;
            const step = getCurrentStepFromButton(button);
            if (validateStep(step)) {
                if (step === 1) showTermsModal();
                else nextStep(step);
            }
        }

        function handlePrevStep(event) {
            const button = event.target;
            const step = getCurrentStepFromButton(button);
            prevStep(step);
        }

        function getCurrentStepFromButton(button) {
            if (!button) return currentStep;
            const formSection = button.closest('.form-section');
            if (!formSection) return currentStep;
            const sectionId = formSection.id;
            const parsed = parseInt(sectionId.replace('step', ''), 10);
            return isNaN(parsed) ? currentStep : parsed;
        }

        function nextStep(step) {
            const currentEl = getEl(`step${step}`);
            if (currentEl) currentEl.classList.remove('active');
            currentStep = step + 1;
            const nextEl = getEl(`step${currentStep}`);
            if (nextEl) nextEl.classList.add('active');
            updateProgress();
            saveFormData();
            if (step === 3 && webcamStream) stopWebcam();
            
            // Auto-save registration when reaching step 5
            if (currentStep === 5) {
                quickSaveRegistration();
            }
        }

        function prevStep(step) {
            const currentEl = getEl(`step${step}`);
            if (currentEl) currentEl.classList.remove('active');
            currentStep = Math.max(1, step - 1);
            const prevEl = getEl(`step${currentStep}`);
            if (prevEl) prevEl.classList.add('active');
            updateProgress();
            saveFormData();
            if (step === 4 && webcamStream) stopWebcam();
        }

        // Validation per step
        function validateStep(step) {
            let isValid = true;
            if (step === 1) isValid = validateStep1();
            else if (step === 2) isValid = validateStep2();
            else if (step === 3) isValid = validateStep3();
            else if (step === 4) isValid = validateStep4();

            if (!isValid) {
                showToast('Please complete all required fields before proceeding.', 'error');
                const firstError = document.querySelector('.error');
                if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return isValid;
        }
        
        function validateCurrentStep() {
            return validateStep(currentStep);
        }

        // Validate Step 1
        function validateStep1() {
            let isValid = true;
            const requiredFields = ['lastName', 'firstName', 'address', 'placeOfBirth', 'dateOfBirth', 'age', 'phone', 'gender', 'civilStatus','citizenship', 'occupation', 'email', 'password'];

            requiredFields.forEach(field => {
                const element = getEl(field);
                const errorElement = getEl(`${field}-error`);
                if (!element || !element.value.trim()) {
                    if (element) element.classList.add('error');
                    if (errorElement) errorElement.style.display = 'block';
                    isValid = false;
                } else {
                    if (element) element.classList.remove('error');
                    if (errorElement) errorElement.style.display = 'none';
                }
            });

            // Validate Middle Name
            const middleName = getEl('middleName');
            const middleNameValue = middleName ? middleName.value.trim() : '';
            if (middleNameValue && middleNameValue.toLowerCase() !== 'n/a' && middleNameValue.length < 2) {
                if (middleName) middleName.classList.add('error');
                if (getEl('middleName-error')) getEl('middleName-error').style.display = 'block';
                isValid = false;
            }

            // phone
            const phone = getEl('phone');
            const phoneError = getEl('phone-error');
            const phoneRegex = /^\+63\s?9\d{2}[- ]?\d{3}[- ]?\d{4}$/;
            if (phone && phone.value && !phoneRegex.test(phone.value)) {
                phone.classList.add('error');
                if (phoneError) {
                    phoneError.textContent = 'Please enter a valid phone number starting with +63 followed by 10 digits';
                    phoneError.style.display = 'block';
                }
                isValid = false;
            }

            // email
            const email = getEl('email');
            const emailError = getEl('email-error');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (email && email.value && !emailRegex.test(email.value)) {
                email.classList.add('error');
                if (emailError) { emailError.textContent = 'Please enter a valid email address'; emailError.style.display = 'block'; }
                isValid = false;
            } else if (email && email.value && !emailVerified) {
                if (emailError) { emailError.textContent = 'Please verify your email with OTP'; emailError.style.display = 'block'; }
                isValid = false;
            }

            // password rules
            const password = getVal('password');
            const passwordError = getEl('password-error');
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            const hasSpecialChar = /[@_><,?]/.test(password);
            const isLongEnough = password.length >= 10;

            if (password && (!hasUpperCase || !hasLowerCase || !hasNumbers || !hasSpecialChar || !isLongEnough)) {
                if (getEl('password')) getEl('password').classList.add('error');
                if (passwordError) passwordError.style.display = 'block';
                isValid = false;
            }

            // confirm
            const confirmPassword = getVal('confirmPassword');
            const confirmPasswordError = getEl('confirmPassword-error');
            const passwordMatchMessage = getEl('password-match-message');

            if (password !== confirmPassword) {
                if (getEl('confirmPassword')) getEl('confirmPassword').classList.add('error');
                if (confirmPasswordError) confirmPasswordError.style.display = 'block';
                if (passwordMatchMessage) passwordMatchMessage.classList.remove('valid');
                isValid = false;
            } else {
                if (getEl('confirmPassword')) getEl('confirmPassword').classList.remove('error');
                if (confirmPasswordError) confirmPasswordError.style.display = 'none';
                if (password && passwordMatchMessage) passwordMatchMessage.classList.add('valid');
            }

            return isValid;
        }

        // Step 2 validation
        function validateStep2() {
            let isValid = true;
            const requiredFields = ['householdMembers', 'ownerName', 'yearsInBarangay'];
            requiredFields.forEach(field => {
                const element = getEl(field);
                const errorElement = getEl(`${field}-error`);
                if (!element || !element.value.trim()) {
                    if (element) element.classList.add('error');
                    if (errorElement) errorElement.style.display = 'block';
                    isValid = false;
                } else {
                    if (element) element.classList.remove('error');
                    if (errorElement) errorElement.style.display = 'none';
                }
            });
            return isValid;
        }

        // Step 3 validation
        function validateStep3() {
            let isValid = true;
            const idFront = getEl('idFront');
            const idBack = getEl('idBack');
            const idType = getEl('idType');
            const userReason = getEl('userReason');

            if (!(idFront && idFront.files && idFront.files.length)) {
                if (getEl('idFront-error')) getEl('idFront-error').style.display = 'block';
                isValid = false;
            } else if (getEl('idFront-error')) getEl('idFront-error').style.display = 'none';

            if (!(idBack && idBack.files && idBack.files.length)) {
                if (getEl('idBack-error')) getEl('idBack-error').style.display = 'block';
                isValid = false;
            } else if (getEl('idBack-error')) getEl('idBack-error').style.display = 'none';

            if (!(idType && idType.value)) {
                if (getEl('idType-error')) getEl('idType-error').style.display = 'block';
                isValid = false;
            } else if (getEl('idType-error')) getEl('idType-error').style.display = 'none';

            if (!(userReason && userReason.value.trim())) {
                if (getEl('userReason-error')) getEl('userReason-error').style.display = 'block';
                isValid = false;
            } else if (getEl('userReason-error')) getEl('userReason-error').style.display = 'none';

            return isValid;
        }

        // Step 4 validation
        function validateStep4() {
            const allCaptured = Object.values(capturedFaces).every(val => val === true);
            if (!allCaptured) {
                showToast('Please complete all face capture steps before proceeding.', 'error');
                return false;
            }
            
            // Generate control number
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            const controlNumber = `BRGY118-${year}${month}${day}-${randomNum}`;
            if (exists('controlNumber')) getEl('controlNumber').textContent = controlNumber;

            formData.controlNumber = controlNumber;
            try { localStorage.setItem('barangayRegistrationControlNumber', controlNumber); } catch (e) { console.warn(e); }

            return true;
        }

        // Terms & modal
        function showTermsModal() {
            if (validateStep1()) {
                if (exists('termsModal')) {
                    getEl('termsModal').style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            } else {
                showToast('Please fill in all required fields before proceeding to the Terms and Conditions.', 'error');
            }
        }

        function closeTermsModal() {
            if (exists('termsModal')) getEl('termsModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        function confirmTerms() {
            const modalAccept = getEl('modal-accept');
            const modalError = getEl('modal-terms-error');
            const termsModal = getEl('termsModal');
            if (!modalAccept) return;
            if (!modalAccept.checked) {
                if (modalError) modalError.style.display = 'block';
                return;
            }
            if (modalError) modalError.style.display = 'none';
            if (termsModal) termsModal.style.display = 'none';
            document.body.style.overflow = '';
            nextStep(1);
        }

        // Password validation & toggles
        function validatePassword() {
            const password = getVal('password');
            const hasUpperCase = /[A-Z]/.test(password);
            const hasLowerCase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            const hasSpecialChar = /[@_><,?]/.test(password);
            const isLongEnough = password.length >= 10;

            if (getEl('req-length')) getEl('req-length').className = isLongEnough ? 'valid' : 'invalid';
            if (getEl('req-uppercase')) getEl('req-uppercase').className = hasUpperCase ? 'valid' : 'invalid';
            if (getEl('req-lowercase')) getEl('req-lowercase').className = hasLowerCase ? 'valid' : 'invalid';
            if (getEl('req-number')) getEl('req-number').className = hasNumbers ? 'valid' : 'invalid';
            if (getEl('req-special')) getEl('req-special').className = hasSpecialChar ? 'valid' : 'invalid';

            validatePasswordConfirmation();
            saveFormData();
        }

        function validatePasswordConfirmation() {
            const password = getVal('password');
            const confirmPassword = getVal('confirmPassword');
            const confirmPasswordError = getEl('confirmPassword-error');
            const passwordMatchMessage = getEl('password-match-message');

            if (password && confirmPassword) {
                if (password !== confirmPassword) {
                    if (getEl('confirmPassword')) getEl('confirmPassword').classList.add('error');
                    if (confirmPasswordError) confirmPasswordError.style.display = 'block';
                    if (passwordMatchMessage) passwordMatchMessage.classList.remove('valid');
                } else {
                    if (getEl('confirmPassword')) getEl('confirmPassword').classList.remove('error');
                    if (confirmPasswordError) confirmPasswordError.style.display = 'none';
                    if (passwordMatchMessage) passwordMatchMessage.classList.add('valid');
                }
            }
        }

        function togglePasswordVisibility() {
            const passwordInput = getEl('password');
            const toggleButton = getEl('togglePassword');
            if (!passwordInput || !toggleButton) return;
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            toggleButton.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i> Show' : '<i class="fas fa-eye-slash"></i> Hide';
        }

        function toggleConfirmPasswordVisibility() {
            const confirmPasswordInput = getEl('confirmPassword');
            const toggleButton = getEl('toggleConfirmPassword');
            if (!confirmPasswordInput || !toggleButton) return;
            const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            confirmPasswordInput.setAttribute('type', type);
            toggleButton.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i> Show' : '<i class="fas fa-eye-slash"></i> Hide';
        }

        // Calculate age
        function calculateAge() {
            const dobVal = getVal('dateOfBirth');
            if (!dobVal) return;
            const dob = new Date(dobVal);
            if (isNaN(dob.getTime())) return;
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const monthDiff = today.getMonth() - dob.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) age--;
            setVal('age', age);
            saveFormData();
        }

        // Webcam
        async function startWebcam() {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'user' } });
                const video = getEl('webcamVideo');
                if (video) video.srcObject = webcamStream;

                if (getEl('startWebcam')) getEl('startWebcam').disabled = true;
                if (getEl('captureImage')) getEl('captureImage').disabled = false;
                if (getEl('capture-front')) getEl('capture-front').disabled = false;

                if (getEl('face-status')) getEl('face-status').innerHTML = '<i class="fas fa-camera"></i> Camera active - Ready for face capture';
                showToast('Camera started successfully!', 'success');
            } catch (err) {
                console.error("Error accessing webcam:", err);
                showToast("Unable to access webcam. Please make sure you've given permission and try again.", 'error');
            }
        }

        function stopWebcam() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
                webcamStream = null;
                const video = getEl('webcamVideo');
                if (video) video.srcObject = null;
                if (getEl('startWebcam')) getEl('startWebcam').disabled = false;
                if (getEl('captureImage')) getEl('captureImage').disabled = true;
                if (getEl('face-status')) getEl('face-status').innerHTML = '<i class="fas fa-times-circle"></i> Camera stopped';
            }
        }

        function captureImage() {
            const video = getEl('webcamVideo');
            const canvas = getEl('webcamCanvas');
            const capturedImage = getEl('capturedImage');
            if (!video || !canvas || !capturedImage) return;

            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;

            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            capturedImage.src = canvas.toDataURL('image/png');
            capturedImage.style.display = 'block';
            video.style.display = 'none';

            if (getEl('captureImage')) getEl('captureImage').style.display = 'none';
            if (getEl('retakeImage')) getEl('retakeImage').style.display = 'inline-block';
        }

        function retakeImage() {
            const video = getEl('webcamVideo');
            const capturedImage = getEl('capturedImage');
            if (!video || !capturedImage) return;

            capturedImage.style.display = 'none';
            video.style.display = 'block';

            if (getEl('captureImage')) getEl('captureImage').style.display = 'inline-block';
            if (getEl('retakeImage')) getEl('retakeImage').style.display = 'none';
        }

        // Quick save registration to Firebase Database
        async function quickSaveRegistration() {
            const data = collectFormData();
            const controlNumber = document.getElementById('controlNumber')?.textContent || 'BRGY118-' + Date.now();
            
            const registration = {
                controlNumber: controlNumber,
                personalInfo: data.personalInfo,
                accountInfo: data.accountInfo,
                householdInfo: data.householdInfo,
                documents: data.documents,
                faceCaptures: data.faceCaptures,
                status: 'pending',
                registrationDate: new Date().toISOString(),
                submittedAt: new Date().toLocaleString(),
                submittedTimestamp: Date.now()
            };

            try {
                // Save to Firebase Realtime Database under "registrations" node
                if (db) {
                    // Create a unique key for the registration
                    const newRegistrationRef = db.ref('registrations').push();
                    await newRegistrationRef.set(registration);
                    
                    console.log('Registration saved to Firebase with key:', newRegistrationRef.key);
                    showToast('Registration submitted successfully to database!', 'success');
                    
                    // Also save to AdminAddUser for admin panel compatibility
                    const adminRef = db.ref('05_AdminAddUser/registrations').push();
                    await adminRef.set(registration);
                    console.log('Registration also saved to AdminAddUser node');
                } else {
                    console.warn('Firebase not available, saving locally only');
                    showToast('Firebase not available. Registration saved locally only.', 'warning');
                }
                
                // Save to localStorage as backup
                const existing = JSON.parse(localStorage.getItem('barangayRegistrations') || '[]');
                const existingIndex = existing.findIndex(reg => reg.controlNumber === controlNumber);
                
                if (existingIndex !== -1) {
                    existing[existingIndex] = registration;
                } else {
                    existing.push(registration);
                }
                
                localStorage.setItem('barangayRegistrations', JSON.stringify(existing));
                
            } catch (error) {
                console.error('Error saving registration to Firebase:', error);
                showToast('Error saving registration to database. Please try again.', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('step5')?.classList.contains('active')) {
                setTimeout(quickSaveRegistration, 500);
            }
        });

        try {
            window.toggleOtherExt = toggleOtherExt;
            window.toggleOtherInput = toggleOtherInput;
            window.toggleIDUpload = function(select) {
                const value = select.value;
                const noIdSection = getEl('no-id-section');
                const idFrontSection = getEl('id-front-section');
                const idBackSection = getEl('id-back-section');
                
                if (value === 'none') {
                    if (noIdSection) noIdSection.style.display = 'block';
                    if (idFrontSection) idFrontSection.style.display = 'none';
                    if (idBackSection) idBackSection.style.display = 'none';
                } else {
                    if (noIdSection) noIdSection.style.display = 'none';
                    if (idFrontSection) idFrontSection.style.display = 'block';
                    if (idBackSection) idBackSection.style.display = 'block';
                }
            };
        } catch (e) {
            console.warn('Unable to attach functions to window:', e);
        }
    </script>
</body>
</html>