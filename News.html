<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barangay 118 News & Announcements</title>
    <link rel="shortcut icon" type="image/png" href="Logo-Favicon-removebg-preview.png">
    <meta name="description" content="Latest news, updates, and announcements from Barangay 118">
    <meta name="keywords" content="barangay news, community updates, announcements, barangay 118 news">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="News.css">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>
    <header id="dynamic-header">
        <!-- Header will be populated by JavaScript -->
    </header>

    <section class="page-hero">
        <div class="container">
            <h2 id="news-hero-title">News & Announcements</h2>
            <p id="news-hero-description">Latest updates, advisories, and community news.</p>
        </div>
    </section>

    <section class="news-section">
        <div class="container">
            <div class="news-header">
                <h2 id="news-section-title">Latest Stories</h2>
                <p class="news-subtitle" id="news-section-subtitle">Stay updated with the latest news and announcements</p>
            </div>
            <div class="news-grid" id="news-grid-container">
                <!-- News will be dynamically loaded here -->
            </div>
        </div>
    </section>

    <section class="events-section">
        <div class="container">
            <h2 class="section-title" id="events-title">Community Events Calendar</h2>
            <div class="events-container">
                <div class="events-grid-container">
                    <div class="events-column">
                        <h3>PAST EVENTS</h3>
                        <div id="past-events-list">
                            <!-- Past events will be dynamically loaded here -->
                        </div>
                    </div>
                    <div class="events-column center">
                        <h3>CURRENT EVENT</h3>
                        <div id="current-event-container">
                            <!-- Current event will be dynamically loaded here -->
                        </div>
                    </div>
                    <div class="events-column">
                        <h3>UPCOMING EVENTS</h3>
                        <div id="upcoming-events-list">
                            <!-- Upcoming events will be dynamically loaded here -->
                        </div>
                    </div>
                </div>
                
                <div class="calendar-container">
                    <div class="calendar-section-inner">
                        <div class="calendar">
                            <div class="calendar-header">
                                <div class="calendar-nav">
                                    <button id="prev-month"><i class="fas fa-chevron-left"></i></button>
                                    <button id="next-month"><i class="fas fa-chevron-right"></i></button>
                                </div>
                                <h3 id="calendar-month">January 2026</h3>
                            </div>
                            <div class="calendar-grid" id="calendar-dates"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- News Modal -->
    <div class="news-modal" id="news-modal">
        <div class="news-modal-content">
            <div class="news-modal-header">
                <h2 class="news-modal-title" id="news-modal-title">News Title</h2>
                <button class="news-modal-close" id="news-modal-close">&times;</button>
            </div>
            <div class="news-modal-meta">
                <div class="news-modal-date" id="news-modal-date"><i class="far fa-calendar"></i> Date</div>
                <div class="news-modal-category" id="news-modal-category">Category</div>
            </div>
            <img id="news-modal-image" src="" alt="" class="news-modal-image">
            <div class="news-modal-body" id="news-modal-body"></div>
            <div class="news-modal-footer">
                <button class="btn-secondary" id="news-modal-close-btn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Event Modal (for calendar events) -->
    <div class="modal" id="event-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-event-title">Event Details</h3>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div class="modal-footer">
                <button class="btn-secondary" id="close-modal-btn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Dynamic Footer (controlled by PanelAdmin.html) -->
    <footer id="dynamic-footer">
        <!-- Footer will be populated by JavaScript -->
    </footer>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAEbKLcaRnMeujiQ2XWx8f5TqTlTC71c0w",
            authDomain: "barangay118-website.firebaseapp.com",
            databaseURL: "https://barangay118-website-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "barangay118-website",
            storageBucket: "barangay118-website.firebasestorage.app",
            messagingSenderId: "255746664706",
            appId: "1:255746664706:web:61d9cd618960147ef6ba1b",
            measurementId: "G-CQFZYJED7Z"
        };

        // Initialize Firebase
        let db = null;
        let unsubscribe = null;
        
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.database();
            console.log("Firebase Realtime Database initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        // Data structure (will be loaded from Firebase)
        let newsData = {
            "01_hero": {
                title: "News & Announcements",
                subtitle: "Latest updates, advisories, and community news for Barangay 118."
            },
            "02_newsSection": {
                title: "Latest Stories",
                subtitle: "Stay updated with the latest news and announcements from Barangay 118"
            },
            "03_news": {
                list: []
            },
            "04_events": {
                title: "Barangay 118 Community Events Calendar",
                allEvents: []
            },
            "05_calendar": {
                events: []
            }
        };

        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();

        // Load data from Firebase Realtime Database (03_news)
        async function loadData() {
            try {
                if (db) {
                    // Load from '03_news' path in Realtime Database
                    const newsRef = db.ref('03_news');
                    const snapshot = await newsRef.once('value');
                    
                    if (snapshot.exists()) {
                        const firebaseData = snapshot.val();
                        
                        // Deep merge Firebase data with local data
                        deepMergeData(newsData, firebaseData);
                        
                        console.log("News data loaded from Firebase Realtime Database (03_news)");
                        localStorage.setItem("newsData", JSON.stringify(newsData));
                    } else {
                        console.log("No Firebase data found in Realtime Database at 03_news, using localStorage");
                        loadFromLocalStorage();
                    }
                } else {
                    console.log("Firebase not available, using localStorage");
                    loadFromLocalStorage();
                }
            } catch (error) {
                console.error("Error loading from Firebase:", error);
                loadFromLocalStorage();
            }
            updateUI();
            renderHeader();
            renderFooter();
        }

        // Deep merge function for nested objects
        function deepMergeData(target, source) {
            for (const key in source) {
                if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                    if (!target[key]) target[key] = {};
                    deepMergeData(target[key], source[key]);
                } else if (Array.isArray(source[key])) {
                    target[key] = source[key];
                } else {
                    target[key] = source[key];
                }
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem("newsData");
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    deepMergeData(newsData, parsedData);
                    console.log("News data loaded from localStorage");
                } else {
                    console.log("Using default News data");
                    // Set some default data if none exists
                    setDefaultData();
                }
            } catch (error) {
                console.error("Error loading from localStorage:", error);
                setDefaultData();
            }
        }

        function setDefaultData() {
            newsData = {
                "01_hero": {
                    title: "News & Announcements",
                    subtitle: "Latest updates, advisories, and community news"
                },
                "02_newsSection": {
                    title: "Latest Stories",
                    subtitle: "Stay updated with the latest news and announcements"
                },
                "03_news": {
                    list: [
                        {
                            id: 1,
                            title: "Japan builds new facility for Grace Park Health Center in Caloocan (2025)",
                            excerpt: "The Embassy of Japan provided around PHP 6 million to construct the new Grace Park Health Center in Caloocan City.",
                            content: "On March 10, 2025, Embassy of Japan Second Secretary MATSUSHIGE Tomoaki attended the turnover ceremony for the 'Project for the Construction of the Grace Park Health Center in Caloocan City.' Japan allocated USD 120,477 (≈ PHP 6 million) under the Official Development Assistance – Grant Assistance for Grass-roots Human Security Projects (GGP). This new facility replaces the old, flood-prone building to ensure safer, cleaner, and modern healthcare services for approximately 9,600 patients annually.",
                            date: "2025-03-10",
                            image: "https://www.ph.emb-japan.go.jp/files/100808323.jpg",
                            category: "Community",
                            readTime: "2 months ago",
                            isFeatured: true
                        },
                        {
                            id: 2,
                            title: "Caloocan Fire: 1 PWD dead, 50 families displaced",
                            excerpt: "A person with disability died after a large fire broke out in Barangay 118, Grace Park, Caloocan in December 2024.",
                            content: "According to Caloocan BFP, the fire started around 2:56 AM at 4th Avenue and quickly spread due to houses being built closely together. 'A PWD died in a fire which razed about 20 houses in Caloocan City…' GMA News reported.",
                            date: "2024-12-29",
                            image: "https://images.gmanews.tv/webpics/2024/12/caloocan_fire_12-29-24_2024_12_29_18_34_08.jpg",
                            category: "Fire",
                            readTime: "2 months ago",
                            isFeatured: false
                        },
                        {
                            id: 3,
                            title: "New Barangay Health Center in Brgy. 118-120, Caloocan",
                            excerpt: "SM Foundation turned over the newly improved Barangay Health Center of Grace Park (Brgy. 118-120) in Caloocan City days before 2024 arrived.",
                            content: "SM Foundation and its partners led this renovation project to turn the facility into a more comfortable and efficient clinic.",
                            date: "2024-01-16",
                            image: "https://i0.wp.com/marketmonitor.com.ph/wp-content/uploads/2024/01/SMFI-image2.jpg?resize=618%2C927&ssl=1",
                            category: "Health",
                            readTime: "2 months ago",
                            isFeatured: false
                        },
                        {
                            id: 4,
                            title: "Barangay 118 Annual Sports Festival",
                            excerpt: "Annual sports competition for youth and adults with various games and activities.",
                            content: "The Barangay 118 Annual Sports Festival is scheduled for November 2025, featuring basketball, volleyball, badminton, and traditional Filipino games.",
                            date: "2025-11-15",
                            image: "https://images.unsplash.com/photo-1546519638-68e109498ffc?auto=format&fit=crop&w=800&q=80",
                            category: "Events",
                            readTime: "2 months ago",
                            isFeatured: false
                        }
                    ]
                },
                "04_events": {
                    title: "Community Events Calendar",
                    allEvents: [
                        {
                            id: 1,
                            title: "New Year's Resolution Forum",
                            description: "Community forum to discuss goals and plans for the new year.",
                            date: "2025-01-10",
                            time: "6:00 PM - 8:00 PM",
                            location: "Barangay 118 Multi-purpose Hall"
                        },
                        {
                            id: 2,
                            title: "Barangay Christmas Party",
                            description: "Annual Christmas celebration for all residents of Barangay 118.",
                            date: "2024-12-15",
                            time: "5:00 PM - 10:00 PM",
                            location: "Barangay 118 Covered Court"
                        },
                        {
                            id: 3,
                            title: "Ongoing Community Programs",
                            description: "Ongoing barangay activities and official announcements.",
                            date: "2025-01-20",
                            time: "Updated regularly",
                            location: "Various Locations",
                            image: ""
                        },
                        {
                            id: 4,
                            title: "Youth Sports Orientation",
                            description: "Orientation for upcoming inter-barangay youth sports activities.",
                            date: "2025-01-25",
                            time: "3:00 PM - 5:00 PM",
                            location: "Barangay 118 Covered Court"
                        },
                        {
                            id: 5,
                            title: "Anti-Dengue Awareness Campaign",
                            description: "Information drive on dengue prevention and barangay clean zones.",
                            date: "2025-02-02",
                            time: "8:00 AM - 11:00 AM",
                            location: "Barangay 118 Plaza"
                        }
                    ]
                },
                "05_calendar": {
                    events: [
                        {
                            id: 1,
                            title: "New Year's Resolution Forum",
                            description: "Community forum to discuss goals and plans for the new year.",
                            date: "2025-01-10",
                            time: "6:00 PM - 8:00 PM",
                            location: "Barangay 118 Multi-purpose Hall",
                            month: "Jan",
                            day: "10"
                        },
                        {
                            id: 2,
                            title: "Barangay Christmas Party",
                            description: "Annual Christmas celebration for all residents of Barangay 118.",
                            date: "2024-12-15",
                            time: "5:00 PM - 10:00 PM",
                            location: "Barangay 118 Covered Court",
                            month: "Dec",
                            day: "15"
                        },
                        {
                            id: 3,
                            title: "Youth Sports Orientation",
                            description: "Orientation for upcoming inter-barangay youth sports activities.",
                            date: "2025-01-25",
                            time: "3:00 PM - 5:00 PM",
                            location: "Barangay 118 Covered Court",
                            month: "Jan",
                            day: "25"
                        }
                    ]
                }
            };
        }

        // Setup Firebase real-time listener for Realtime Database (03_news)
        function setupFirebaseListener() {
            if (!db) return;
            
            try {
                const newsRef = db.ref('03_news');
                let isFirstLoad = true;
                
                unsubscribe = newsRef.on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const firebaseData = snapshot.val();
                        
                        // Deep merge Firebase data
                        deepMergeData(newsData, firebaseData);
                        
                        updateUI();
                        renderHeader();
                        renderFooter();
                        localStorage.setItem("newsData", JSON.stringify(newsData));
                        console.log("News data updated from Firebase in real-time (03_news)");
                        
                        if (!isFirstLoad) {
                            showToast('News content updated from admin!', 'success');
                        } else {
                            isFirstLoad = false;
                        }
                    }
                }, (error) => {
                    console.error("Firebase listener error:", error);
                });
            } catch (error) {
                console.error("Failed to setup Firebase listener:", error);
            }
        }

        // Render dynamic header - Load header data from main admin panel (01_main)
        async function renderHeader() {
            const headerContainer = document.getElementById('dynamic-header');
            if (!headerContainer) return;
            
            let headerData = {
                systemName: "BARANGAY 118 ONLINE SYSTEM",
                hero: {
                    headerLogo: "Logo-Favicon-removebg-preview.png"
                }
            };
            
            try {
                if (db) {
                    const mainDataRef = db.ref('01_main');
                    const snapshot = await mainDataRef.once('value');
                    
                    if (snapshot.exists()) {
                        const firebaseData = snapshot.val();
                        
                        if (firebaseData["01_systemName"]) {
                            headerData.systemName = firebaseData["01_systemName"];
                        }
                        
                        if (firebaseData["02_hero"]?.headerLogo) {
                            headerData.hero.headerLogo = firebaseData["02_hero"].headerLogo;
                        }
                    }
                }
            } catch (error) {
                console.error("Error loading header data:", error);
            }
            
            const currentPage = window.location.pathname.split('/').pop();
            
            headerContainer.innerHTML = `
                <div class="container">
                    <div class="navbar">
                        <a href="index.html" id="home-logo" class="logo" aria-label="Barangay 118 Online System Home">
                            <img src="${headerData.hero.headerLogo}" 
                                 alt="Barangay 118 Official Logo" 
                                 class="logo-image" 
                                 id="header-logo" 
                                 width="70" height="70">
                            <h1 id="system-name">${headerData.systemName}</h1>
                        </a>

                        <nav class="nav-links" aria-label="Main navigation">
                            <a href="index.html" ${currentPage === 'index.html' || currentPage === '' ? 'class="active"' : ''} aria-label="Home page">
                                <i class="fas fa-home" aria-hidden="true"></i>
                                <span>Home</span>
                            </a>
                            <a href="AboutUs.html" ${currentPage === 'AboutUs.html' ? 'class="active"' : ''} aria-label="About Barangay 118 page">
                                <i class="fas fa-info-circle" aria-hidden="true"></i>
                                <span>About Us</span>
                            </a>
                            <a href="News.html" ${currentPage === 'News.html' ? 'class="active"' : ''} aria-current="page" aria-label="Barangay News page">
                                <i class="fas fa-newspaper" aria-hidden="true"></i>
                                <span>News</span>
                            </a>
                            <a href="Emergency.html" ${currentPage === 'Emergency.html' ? 'class="active"' : ''} aria-label="Barangay Emergency page">
                                <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                                <span>Emergency</span>
                            </a>
                            <a href="CreateAnAccount.html" ${currentPage === 'CreateAnAccount.html' ? 'class="active"' : ''} aria-label="Create an account page">
                                <i class="fas fa-user-plus" aria-hidden="true"></i>
                                <span>Create Account</span>
                            </a>
                            <a href="LogIn.html" ${currentPage === 'LogIn.html' ? 'class="active"' : ''} aria-label="Login page">
                                <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                                <span>Login</span>
                            </a>
                        </nav>
                    </div>
                </div>
            `;
        }

        // Render dynamic footer - Load footer data from main admin panel (01_main)
        async function renderFooter() {
            const footerContainer = document.getElementById('dynamic-footer');
            if (!footerContainer) return;
            
            let footerData = {
                title: "Barangay 118 Online System",
                description: "Secure and efficient online services for Barangay 118. Connecting our community through technology.",
                contactInfo: {
                    addressLine1: "402 2nd St, Grace Park East, Caloocan",
                    addressLine2: "Metro Manila, Philippines",
                    phone: "(02) 8123-4567",
                    email: "info@barangay118.gov.ph",
                    officeHours: "Mon–Fri: 8:00 AM – 5:00 PM"
                },
                socialMedia: {
                    facebook: "https://facebook.com/barangay118",
                    messenger: "https://m.me/barangay118"
                },
                copyright: "&copy; 2025 Barangay 118 Online System. All Rights Reserved."
            };
            
            try {
                if (db) {
                    const mainDataRef = db.ref('01_main');
                    const snapshot = await mainDataRef.once('value');
                    
                    if (snapshot.exists()) {
                        const firebaseData = snapshot.val();
                        const footerSource = firebaseData["04_footer"] || {};
                        
                        if (footerSource.title) footerData.title = footerSource.title;
                        if (footerSource.description) footerData.description = footerSource.description;
                        
                        if (footerSource.contactInfo) {
                            if (footerSource.contactInfo.addressLine1) footerData.contactInfo.addressLine1 = footerSource.contactInfo.addressLine1;
                            if (footerSource.contactInfo.addressLine2) footerData.contactInfo.addressLine2 = footerSource.contactInfo.addressLine2;
                            if (footerSource.contactInfo.phone) footerData.contactInfo.phone = footerSource.contactInfo.phone;
                            if (footerSource.contactInfo.email) footerData.contactInfo.email = footerSource.contactInfo.email;
                            if (footerSource.contactInfo.officeHours) footerData.contactInfo.officeHours = footerSource.contactInfo.officeHours;
                        }
                        
                        if (footerSource.socialMedia) {
                            if (footerSource.socialMedia.facebook) footerData.socialMedia.facebook = footerSource.socialMedia.facebook;
                            if (footerSource.socialMedia.messenger) footerData.socialMedia.messenger = footerSource.socialMedia.messenger;
                        }
                        
                        if (footerSource.copyright) footerData.copyright = footerSource.copyright;
                    }
                }
            } catch (error) {
                console.error("Error loading footer data:", error);
            }
            
            footerContainer.innerHTML = `
                <div class="container" id="footer-container">
                    <div class="footer-content" id="footer-content">
                        <!-- Left Column: System Info -->
                        <div class="footer-column" id="footer-system-column">
                            <h3 id="footer-title" class="footer-title">
                                ${footerData.title}
                            </h3>
                            <p id="footer-description" class="footer-description">
                                ${footerData.description}
                            </p>
                        </div>

                        <!-- Center Footer -->
                        <div class="footer-center" id="footer-center">
                            <div class="footer-row" id="footer-row">
                                <!-- Contact Info -->
                                <div class="footer-column" id="footer-contact-column">
                                    <h3 id="footer-contact-title">Contact Info</h3>
                                    <ul id="footer-contact-info" class="footer-contact-info">
                                        <li>
                                            <i class="fas fa-map-marker-alt"></i>
                                            <span id="footer-address-line1">
                                                ${footerData.contactInfo.addressLine1}
                                            </span>
                                        </li>
                                        <li>
                                            <i class="fas fa-map-pin"></i>
                                            <span id="footer-address-line2">
                                                ${footerData.contactInfo.addressLine2}
                                            </span>
                                        </li>
                                        <li>
                                            <i class="fas fa-phone"></i>
                                            <span id="footer-phone">
                                                ${footerData.contactInfo.phone}
                                            </span>
                                        </li>
                                        <li>
                                            <i class="fas fa-envelope"></i>
                                            <span id="footer-email">
                                                ${footerData.contactInfo.email}
                                            </span>
                                        </li>
                                        <li>
                                            <i class="fas fa-clock"></i>
                                            <span id="footer-office-hours">
                                                ${footerData.contactInfo.officeHours}
                                            </span>
                                        </li>
                                    </ul>
                                </div>

                                <!-- Social / Links -->
                                <div class="footer-column" id="footer-links-column">
                                    <h3 id="footer-social-title">Follow Us</h3>
                                    <ul class="footer-links" id="footer-social-links">
                                        <li id="footer-facebook-item">
                                            <i class="fab fa-facebook"></i>
                                            <a id="footer-facebook-link" href="${footerData.socialMedia.facebook}" target="_blank">
                                                <span id="footer-facebook-text"> Facebook</span>
                                            </a>
                                        </li>
                                        <li id="footer-messenger-item">
                                            <i class="fab fa-facebook-messenger"></i>
                                            <a id="footer-messenger-link" href="${footerData.socialMedia.messenger}" target="_blank">
                                                <span id="footer-messenger-text"> Messenger Chat</span>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Copyright -->
                    <div class="copyright" id="footer-copyright">
                        <p id="copyright-text">
                            ${footerData.copyright}
                        </p>
                    </div>
                </div>`;
        }

        function updateUI() {
            try {
                const newsHeroTitle = document.getElementById("news-hero-title");
                if (newsHeroTitle && newsData["01_hero"]?.title) newsHeroTitle.textContent = newsData["01_hero"].title;
                
                const newsHeroDesc = document.getElementById("news-hero-description");
                if (newsHeroDesc && newsData["01_hero"]?.subtitle) newsHeroDesc.textContent = newsData["01_hero"].subtitle;
                
                const newsSectionTitle = document.getElementById("news-section-title");
                if (newsSectionTitle && newsData["02_newsSection"]?.title) newsSectionTitle.textContent = newsData["02_newsSection"].title;
                
                const newsSectionSubtitle = document.getElementById("news-section-subtitle");
                if (newsSectionSubtitle && newsData["02_newsSection"]?.subtitle) newsSectionSubtitle.textContent = newsData["02_newsSection"].subtitle;
                const eventsTitle = document.getElementById("events-title");
                if (eventsTitle && newsData["04_events"]?.title) eventsTitle.textContent = newsData["04_events"].title;

                renderNews(newsData["03_news"]?.list || []);
                
                renderEvents(newsData["04_events"]?.allEvents || []);
                
                generateCalendar(currentMonth, currentYear);
                
                console.log("News UI updated successfully");
            } catch (error) {
                console.error("Error updating UI:", error);
            }
        }

        // Format date function
        function formatDate(dateString) {
            if (!dateString) return '';

            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return dateString;
            }
            
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        // Render news dynamically
        function renderNews(newsList) {
            const newsGrid = document.getElementById('news-grid-container');
            if (!newsGrid) return;

            newsGrid.innerHTML = '';

            if (!newsList || newsList.length === 0) {
                newsGrid.innerHTML = '<div class="no-news" style="text-align: center; color: var(--gray); grid-column: 1 / -1; padding: 40px;">No news available at the moment.</div>';
                return;
            }

            // Sort news by date (newest first)
            const sortedNews = [...newsList].sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });

            const featuredNews = sortedNews.find(news => news.isFeatured) || sortedNews[0];
            const regularNews = sortedNews.filter(news => news.id !== featuredNews.id).slice(0, 3);

            const featuredHtml = `
                <div class="featured-news">
                    <div class="featured-card">
                        <div class="featured-image-container">
                            <img src="${featuredNews.image}" alt="${featuredNews.title}" class="featured-image" onerror="this.src='https://via.placeholder.com/800x400?text=News+Image'">
                            <div class="featured-badge">${featuredNews.category}</div>
                        </div>
                        <div class="featured-content">
                            <div class="featured-date">
                                <i class="far fa-calendar"></i> ${formatDate(featuredNews.date)}
                            </div>
                            <h3 class="featured-title">${featuredNews.title}</h3>
                            <p class="featured-excerpt">${featuredNews.excerpt}</p>
                            <a href="#" class="featured-read-more" data-news-id="${featuredNews.id}"> Read More <i class="fas fa-arrow-right"></i> </a>
                        </div>
                    </div>
                </div>`;

            let newsListHtml = `
                <div class="news-list">
                    <div class="news-list-header">
                        <h3 class="news-list-title">Mga Balita</h3>
                    </div>
                    <div class="news-list-items">`;

            regularNews.forEach(news => {
                newsListHtml += `
                    <div class="news-item" data-news-id="${news.id}">
                        <div class="news-item-image-container">
                            <img src="${news.image}" alt="${news.title}" class="news-item-image" onerror="this.src='https://via.placeholder.com/300x200?text=News'">
                            <div class="news-item-badge">${news.category}</div>
                        </div>
                        <div class="news-item-content">
                            <div class="news-item-date">
                                <i class="far fa-calendar"></i> ${formatDate(news.date)}
                            </div>
                            <h4 class="news-item-title">${news.title}</h4>
                            <p class="news-item-excerpt">${news.excerpt}</p>
                            <div class="news-item-meta">
                                <a href="#" class="news-item-read-more" data-news-id="${news.id}"> Read More <i class="fas fa-arrow-right"></i> </a>
                                <span class="news-item-read-time"><i class="far fa-clock"></i> ${news.readTime}</span>
                            </div>
                        </div>
                    </div>`;
            });

            newsListHtml += `
                    </div>
                </div>`;
            
            newsGrid.innerHTML = featuredHtml + newsListHtml;
            setupNewsEventListeners();
        }

        function renderEvents(eventsList) {
            const today = new Date().toISOString().split('T')[0];
            const pastEvents = eventsList.filter(event => event.date < today);
            const currentEvents = eventsList.filter(event => event.date === today);
            const upcomingEvents = eventsList.filter(event => event.date > today);
            
            const pastContainer = document.getElementById('past-events-list');
            if (pastContainer) {
                pastContainer.innerHTML = '';
                if (pastEvents.length === 0) {
                    pastContainer.innerHTML = '<div class="events-list-item"><h4>No Past Events</h4><p>No past events to display.</p></div>';
                } else {
                    const sortedPast = [...pastEvents].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 4);
                    sortedPast.forEach(event => {
                        pastContainer.innerHTML += `
                            <div class="events-list-item">
                                <h4>${event.title}</h4>
                                <p>${event.description}</p>
                                <small><i class="far fa-calendar"></i> ${formatDate(event.date)}</small>
                            </div>`;
                    });
                }
            }
            
            const currentContainer = document.getElementById('current-event-container');
            if (currentContainer) {
                currentContainer.innerHTML = '';
                if (currentEvents.length === 0) {
                    currentContainer.innerHTML = `
                        <div class="event-card">
                            <div class="event-image-placeholder">NO EVENT TODAY</div>
                            <div class="event-card-content">
                                <h4 style="margin-bottom: 10px; color: var(--dark);">No Event Today</h4>
                                <p class="event-desc">No event scheduled for today.</p>
                                <span class="event-sub">Check upcoming events</span>
                            </div>
                        </div>`;
                } else {
                    const currentEvent = currentEvents[0];
                    // GUMAMIT NG BAGONG STRUCTURE PARA SA IMAGE HEIGHT FIX
                    currentContainer.innerHTML = `
                        <div class="event-card">
                            <div class="event-card-image-container">
                                ${currentEvent.image ? 
                                    `<img src="${currentEvent.image}" alt="${currentEvent.title}" class="event-card-image" onerror="this.src='https://via.placeholder.com/350x200?text=Event'">` : 
                                    `<div class="event-image-placeholder">CURRENT EVENT</div>`
                                }
                            </div>
                            <div class="event-card-content">
                                <h4 style="margin-bottom: 10px; color: var(--dark);">${currentEvent.title}</h4>
                                <p class="event-desc">${currentEvent.description}</p>
                                <span class="event-sub">
                                    ${currentEvent.time || ''} ${currentEvent.location ? `• ${currentEvent.location}` : ''}
                                </span>
                            </div>
                        </div>`;
                }
            }
            
            const upcomingContainer = document.getElementById('upcoming-events-list');
            if (upcomingContainer) {
                upcomingContainer.innerHTML = '';
                if (upcomingEvents.length === 0) {
                    upcomingContainer.innerHTML = '<div class="events-list-item"><h4>No Upcoming Events</h4><p>No upcoming events scheduled.</p></div>';
                } else {
                    const sortedUpcoming = [...upcomingEvents].sort((a, b) => new Date(a.date) - new Date(b.date)).slice(0, 4);
                    sortedUpcoming.forEach(event => {
                        upcomingContainer.innerHTML += `
                            <div class="events-list-item">
                                <h4>${event.title}</h4>
                                <p>${event.description}</p>
                                <small><i class="far fa-calendar"></i> ${formatDate(event.date)}</small>
                            </div>`;
                    });
                }
            }
        }

        // Show news modal
        function showNewsModal(newsId) {
            const newsList = newsData["03_news"]?.list || [];
            const newsItem = newsList.find(item => item.id === newsId);
            
            if (newsItem) {
                document.getElementById('news-modal-title').textContent = newsItem.title;
                document.getElementById('news-modal-date').innerHTML = `<i class="far fa-calendar"></i> ${formatDate(newsItem.date)}`;
                document.getElementById('news-modal-category').textContent = newsItem.category;
                document.getElementById('news-modal-image').src = newsItem.image;
                document.getElementById('news-modal-image').alt = newsItem.title;
                document.getElementById('news-modal-body').innerHTML = `
                    <p>${newsItem.content}</p>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--gray-light); color: var(--gray);">
                        <i class="far fa-clock"></i> ${newsItem.readTime}
                    </div>`;
                document.getElementById('news-modal').style.display = 'flex';
            }
        }

        function closeNewsModal() {
            document.getElementById('news-modal').style.display = 'none';
        }

        function setupNewsEventListeners() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('featured-read-more') || 
                    e.target.classList.contains('news-item-read-more') ||
                    e.target.parentElement.classList.contains('featured-read-more') ||
                    e.target.parentElement.classList.contains('news-item-read-more')) {
                    e.preventDefault();
                    const newsId = parseInt(e.target.getAttribute('data-news-id') || 
                    e.target.parentElement.getAttribute('data-news-id'));
                    showNewsModal(newsId);
                }
                
                if (e.target.closest('.news-item')) {
                    e.preventDefault();
                    const newsItem = e.target.closest('.news-item');
                    const newsId = parseInt(newsItem.getAttribute('data-news-id'));
                    showNewsModal(newsId);
                }
            });
            
            const newsModalClose = document.getElementById('news-modal-close');
            if (newsModalClose) {
                newsModalClose.addEventListener('click', closeNewsModal);
            }
            
            const newsModalCloseBtn = document.getElementById('news-modal-close-btn');
            if (newsModalCloseBtn) {
                newsModalCloseBtn.addEventListener('click', closeNewsModal);
            }
            
            window.addEventListener('click', (e) => {
                if (e.target === document.getElementById('news-modal')) {
                    closeNewsModal();
                }
            });
        }

        function generateCalendar(month, year) {
            const calendarDates = document.getElementById('calendar-dates');
            if (!calendarDates) return;
            
            calendarDates.innerHTML = '';

            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            const monthShortNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
            ];
            
            if (document.getElementById('calendar-month')) {
                document.getElementById('calendar-month').textContent = `${monthNames[month]} ${year}`;
            }
            
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                calendarDates.appendChild(dayElement);
            });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            for (let i = firstDay - 1; i >= 0; i--) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-date other-month';
                const dateNumber = document.createElement('span');
                dateNumber.className = 'date-number';
                dateNumber.textContent = daysInPrevMonth - i;
                emptyCell.appendChild(dateNumber);
                calendarDates.appendChild(emptyCell);
            }
            
            const today = new Date();
            for (let i = 1; i <= daysInMonth; i++) {
                const dateElement = document.createElement('div');
                dateElement.className = 'calendar-date';
                dateElement.dataset.date = `${year}-${month + 1}-${i}`;

                const dateNumber = document.createElement('span');
                dateNumber.className = 'date-number';
                dateNumber.textContent = i;
                dateElement.appendChild(dateNumber);

                if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dateElement.classList.add('today');
                }

                const eventsForDate = (newsData["05_calendar"]?.events || []).filter(event => {
                    const eventDate = new Date(event.date);
                    return eventDate.getDate() === i && 
                           eventDate.getMonth() === month && 
                           eventDate.getFullYear() === year;
                });
                
                if (eventsForDate.length > 0) {
                    dateElement.classList.add('event');
                    const eventIndicator = document.createElement('div');
                    eventIndicator.className = 'event-indicator';
                    eventsForDate.forEach(() => {
                        const eventDot = document.createElement('div');
                        eventDot.className = 'event-dot';
                        eventIndicator.appendChild(eventDot);
                    });
                    dateElement.appendChild(eventIndicator);
                    dateElement.addEventListener('click', () => showEventDetails(i, month, year));
                } else {
                    dateElement.addEventListener('click', () => {
                        const modalBody = document.getElementById('modal-body');
                        modalBody.innerHTML = `
                            <div class="modal-event-date">
                                <i class="far fa-calendar-alt"></i>
                                <span>${monthNames[month]} ${i}, ${year}</span>
                            </div>
                            <h3 class="modal-event-title">No Events Scheduled</h3>
                            <p class="modal-event-description">There are no events scheduled for this date. Check back later for updates!</p>`;
                        document.getElementById('event-modal').style.display = 'flex';
                    });
                }
                calendarDates.appendChild(dateElement);
            }
            
            // Next month days
            const totalCells = 42; // 6 rows * 7 columns
            const cellsUsed = firstDay + daysInMonth;
            const remainingCells = totalCells - cellsUsed;
            
            for (let i = 1; i <= remainingCells; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-date other-month';
                const dateNumber = document.createElement('span');
                dateNumber.className = 'date-number';
                dateNumber.textContent = i;
                emptyCell.appendChild(dateNumber);
                calendarDates.appendChild(emptyCell);
            }
        }
        
        function showEventDetails(day, month, year) {
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            const eventsForDate = (newsData["05_calendar"]?.events || []).filter(event => {
                const eventDate = new Date(event.date);
                return eventDate.getDate() === day && 
                       eventDate.getMonth() === month && 
                       eventDate.getFullYear() === year;
            });
            
            if (eventsForDate.length > 0) {
                const modalBody = document.getElementById('modal-body');
                if (eventsForDate.length > 1) {
                    modalBody.innerHTML = `
                        <div class="modal-event-date">
                            <i class="far fa-calendar-alt"></i>
                            <span>${monthNames[month]} ${day}, ${year}</span>
                            <span style="margin-left: auto; font-size: 0.9rem; color: var(--gray);">
                                ${eventsForDate.length} events
                            </span>
                        </div>
                        <h3 class="modal-event-title">Events on ${monthNames[month]} ${day}</h3>
                    `;
                    
                    eventsForDate.forEach((event, index) => {
                        modalBody.innerHTML += `
                            <div style="margin-bottom: 20px; padding: 15px; background: var(--gray-light); border-radius: 10px;">
                                <h4 style="margin-bottom: 10px; color: var(--primary);">${event.title}</h4>
                                <p style="margin-bottom: 10px; color: var(--gray);">${event.description}</p>
                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                    <div class="modal-event-detail">
                                        <i class="far fa-clock"></i>
                                        <span>${event.time}</span>
                                    </div>
                                    <div class="modal-event-detail">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>${event.location}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    // Single event
                    const event = eventsForDate[0];
                    modalBody.innerHTML = `
                        <div class="modal-event-date">
                            <i class="far fa-calendar-alt"></i>
                            <span>${monthNames[month]} ${day}, ${year}</span>
                        </div>
                        <h3 class="modal-event-title">${event.title}</h3>
                        <p class="modal-event-description">${event.description}</p>
                        <div class="modal-event-details">
                            <div class="modal-event-detail">
                                <i class="far fa-clock"></i>
                                <span>${event.time}</span>
                            </div>
                            <div class="modal-event-detail">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${event.location}</span>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('event-modal').style.display = 'flex';
            }
        }

        // Set up event listeners for calendar
        function setupCalendarEventListeners() {
            // Calendar navigation
            const prevMonthBtn = document.getElementById('prev-month');
            if (prevMonthBtn) {
                prevMonthBtn.addEventListener('click', () => {
                    currentMonth--;
                    if (currentMonth < 0) {
                        currentMonth = 11;
                        currentYear--;
                    }
                    generateCalendar(currentMonth, currentYear);
                });
            }
            
            const nextMonthBtn = document.getElementById('next-month');
            if (nextMonthBtn) {
                nextMonthBtn.addEventListener('click', () => {
                    currentMonth++;
                    if (currentMonth > 11) {
                        currentMonth = 0;
                        currentYear++;
                    }
                    generateCalendar(currentMonth, currentYear);
                });
            }
            
            const closeModalBtn = document.getElementById('close-modal');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', () => {
                    document.getElementById('event-modal').style.display = 'none';
                });
            }

            const closeModalFooterBtn = document.getElementById('close-modal-btn');
            if (closeModalFooterBtn) {
                closeModalFooterBtn.addEventListener('click', () => {
                    document.getElementById('event-modal').style.display = 'none';
                });
            }

            window.addEventListener('click', (e) => {
                if (e.target === document.getElementById('event-modal')) {
                    document.getElementById('event-modal').style.display = 'none';
                }
            });
        }

        function showToast(message, type = 'info') {
            const toast = document.querySelector('.toast');
            if (toast) {
                const icon = type === 'success' ? 'fa-check-circle' : 
                            type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
                toast.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
                
                if (type === 'success') {
                    toast.style.background = 'var(--success)';
                } else if (type === 'error') {
                    toast.style.background = 'var(--error)';
                } else {
                    toast.style.background = 'var(--primary)';
                }
                
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 4000);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupFirebaseListener();
            generateCalendar(currentMonth, currentYear);
            setupCalendarEventListeners();
            
            window.addEventListener('storage', function(e) {
                if (e.key === 'newsData') {
                    loadFromLocalStorage();
                    updateUI();
                    renderHeader();
                    renderFooter();
                    showToast('News content updated from admin panel!', 'success');
                }
            });
            
            console.log("News page loaded successfully");
        });

        window.addEventListener('beforeunload', function() {
            if (unsubscribe) {
                unsubscribe();
            }
        });
    </script>
</body>
</html>